<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RegSecure AI Pro - Secure Contract Analysis</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="AI contract analysis that runs 100% locally. No cloud uploads, no data leaks. Analyze NDAs, SaaS agreements, and DPAs with patent-pending privacy technology.">
    <meta name="keywords" content="contract analysis, legal AI, local AI, privacy, NDA, SaaS agreement, document analysis, risk detection">
    <meta name="author" content="Particular Ltd">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="RegSecure AI Pro - 100% Local Contract Analysis">
    <meta property="og:description" content="AI contract analysis that never leaves your device. No cloud, no uploads, no data leaks.">
    <meta property="og:image" content="https://regsecure.ai/og-image.png">
    <meta property="og:url" content="https://regsecure.ai">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="RegSecure AI Pro - 100% Local Contract Analysis">
    <meta name="twitter:description" content="AI contract analysis that never leaves your device.">
    
    <!-- Favicon (inline SVG) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%233b82f6'/%3E%3Cstop offset='100%25' stop-color='%231d4ed8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M50 5 L90 20 L90 50 Q90 75 50 95 Q10 75 10 50 L10 20 Z' fill='url(%23g)'/%3E%3Crect x='30' y='25' width='40' height='50' rx='4' fill='white' fill-opacity='0.95'/%3E%3Cpath d='M55 25 L70 25 L70 40 L55 40 Z' fill='%23bfdbfe'/%3E%3Cline x1='37' y1='45' x2='63' y2='45' stroke='%2393c5fd' stroke-width='3' stroke-linecap='round'/%3E%3Cline x1='37' y1='55' x2='57' y2='55' stroke='%2393c5fd' stroke-width='3' stroke-linecap='round'/%3E%3Cline x1='37' y1='65' x2='50' y2='65' stroke='%2393c5fd' stroke-width='3' stroke-linecap='round'/%3E%3Ccircle cx='70' cy='68' r='14' fill='%2316a34a'/%3E%3Cpath d='M63 68 L68 73 L77 64' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22RegSecure%20AI%20Pro%22%2C%22short_name%22%3A%22RegSecure%22%2C%22description%22%3A%22Local%20AI%20Contract%20Analysis%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230f172a%22%2C%22theme_color%22%3A%22%233b82f6%22%7D">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Mammoth.js for Word docs -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Transformers.js - loaded as module for main thread fallback -->
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';
        env.backends.onnx.wasm.numThreads = 4;
        window.TransformersJS = { pipeline, env };
        window.dispatchEvent(new Event('transformers-ready'));
    </script>
    
    <!-- WebLLM -->
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";
        window.webllm = webllm;
        window.dispatchEvent(new Event('webllm-ready'));
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap');
        
        /* === ◊î◊í◊ì◊ú◊™ ◊ò◊ß◊°◊ò ◊ï◊®◊ï◊ï◊ó◊ô◊ù === */
        html { font-size: 17px !important; }
        body { font-family: 'Inter', 'Heebo', system-ui, sans-serif; line-height: 1.7; }
        p, li, span, div { line-height: 1.7; }
        .text-xs { font-size: 0.8rem !important; }
        .text-\[10px\] { font-size: 0.75rem !important; }
        .text-\[9px\] { font-size: 0.7rem !important; }
        
        .scrollbar-thin::-webkit-scrollbar { width: 5px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .loader { width: 20px; height: 20px; border: 2px solid #334155; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sidebar-item { transition: all 0.15s ease; }
        .sidebar-item:hover { background: rgba(59, 130, 246, 0.1); }
        .sidebar-item.active { background: rgba(59, 130, 246, 0.15); border-color: #3b82f6; }
        
        .section-card.relevant { background: rgba(59, 130, 246, 0.1); border-color: #3b82f6; }
        .similarity-bar { height: 3px; background: linear-gradient(90deg, #3b82f6, #3b82f6); border-radius: 2px; transition: width 0.3s; }
        
        .modal-backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring circle { transition: stroke-dashoffset 0.3s; }
        
        .stage-badge { transition: all 0.2s; }
        .stage-badge.active { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #c4b5fd; }
        .stage-badge.done { background: rgba(16, 185, 129, 0.2); border-color: #16a34a; color: #6ee7b7; }
        
        /* Risk Highlighting */
        .risk-high { 
            background: rgba(239, 68, 68, 0.15); 
            border-left: 3px solid #ef4444; 
            padding-left: 8px;
        }
        .risk-medium { 
            background: rgba(245, 158, 11, 0.15); 
            border-left: 3px solid #f59e0b; 
            padding-left: 8px;
        }
        .risk-low { 
            background: rgba(16, 185, 129, 0.15); 
            border-left: 3px solid #16a34a; 
            padding-left: 8px;
        }
        .risk-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .risk-badge.high { background: #ef4444; color: white; }
        .risk-badge.medium { background: #f59e0b; color: white; }
        .risk-badge.low { background: #16a34a; color: white; }
        
        /* Light Theme */
        body.light-theme {
            background: #f8fafc;
            color: #1e293b;
        }
        body.light-theme .bg-slate-900, body.light-theme .bg-slate-900\/80, 
        body.light-theme .bg-slate-900\/50, body.light-theme .bg-slate-900\/30 {
            background: #ffffff !important;
        }
        body.light-theme .bg-slate-800, body.light-theme .bg-slate-800\/50,
        body.light-theme .bg-slate-800\/30 {
            background: #f1f5f9 !important;
        }
        body.light-theme .bg-slate-950 {
            background: #f8fafc !important;
        }
        body.light-theme .text-slate-200, body.light-theme .text-slate-300,
        body.light-theme .text-slate-400 {
            color: #475569 !important;
        }
        body.light-theme .text-white {
            color: #1e293b !important;
        }
        body.light-theme .text-slate-500, body.light-theme .text-slate-600 {
            color: #64748b !important;
        }
        body.light-theme .border-slate-800, body.light-theme .border-slate-700 {
            border-color: #e2e8f0 !important;
        }
        body.light-theme .modal-backdrop {
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* Print Styles */
        @media print {
            body { background: white !important; color: black !important; }
            header, aside, #suggestionsArea, button, .modal-backdrop { display: none !important; }
            #mainApp, main, section { display: block !important; width: 100% !important; height: auto !important; overflow: visible !important; }
            #chatArea { height: auto !important; overflow: visible !important; }
            .chat-msg { page-break-inside: avoid; margin-bottom: 10px; }
            .bg-slate-800\/50, .bg-blue-600\/20 { background: #f0f0f0 !important; }
        }
        
        /* Chunk Navigator */
        .chunk-nav {
            position: fixed;
            right: 340px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 30;
        }
        .chunk-nav button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.8);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chunk-nav button:hover {
            background: #3b82f6;
            transform: scale(1.1);
        }
        
        /* Comparison highlights */
        .diff-added { background: rgba(16, 185, 129, 0.2); }
        .diff-removed { background: rgba(239, 68, 68, 0.2); text-decoration: line-through; }
        .diff-changed { background: rgba(245, 158, 11, 0.2); }
        
        /* Toast Notifications */
        .toast-enter { animation: slideIn 0.3s ease forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-950 text-slate-200">

<!-- ========== TOAST CONTAINER ========== -->
<div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

<!-- ========== UNLOCK MODAL ========== -->
<!-- ========== MOBILE WARNING ========== -->
<div id="mobileWarning" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden">
    <div class="bg-slate-900 rounded-2xl p-8 max-w-sm w-full mx-4 border border-amber-500/30 shadow-2xl fade-in text-center">
        <div class="w-16 h-16 bg-amber-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
        </div>
        <h2 class="text-xl font-bold text-white mb-2">Desktop Recommended</h2>
        <p class="text-slate-400 text-sm mb-6">
            RegSecure AI Pro requires significant processing power for local AI analysis. For the best experience, please use a desktop or laptop computer.
        </p>
        <div class="flex flex-col gap-2">
            <button onclick="dismissMobileWarning()" ontouchend="dismissMobileWarning()" class="w-full bg-amber-500 hover:bg-amber-400 text-black font-semibold py-2.5 rounded-xl transition">
                Continue Anyway
            </button>
            <p class="text-[10px] text-slate-600">Performance may be limited on mobile devices</p>
        </div>
    </div>
</div>

<!-- WebGPU Warning Banner -->
<div id="webgpuWarning" class="hidden fixed top-0 left-0 right-0 z-[100] bg-amber-600 text-white px-4 py-3 text-center">
    <div class="flex items-center justify-center gap-3 flex-wrap">
        <span class="text-lg">‚ö†Ô∏è</span>
        <span class="font-medium">Your browser doesn't support WebGPU.</span>
        <span class="text-amber-100">AI features require Chrome, Edge, or Safari 26+.</span>
        <button onclick="document.getElementById('webgpuWarning').classList.add('hidden')" class="ml-2 bg-amber-700 hover:bg-amber-800 px-3 py-1 rounded text-sm">
            Dismiss
        </button>
    </div>
</div>

<div id="unlockModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 rounded-2xl p-8 max-w-md w-full mx-4 border border-slate-800 shadow-2xl fade-in">
        <!-- Logo & Branding -->
        <div class="text-center mb-6">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-600/15 relative">
                <!-- Document icon -->
                <svg class="w-10 h-10" viewBox="0 0 40 50" fill="none">
                    <rect x="2" y="2" width="30" height="40" rx="3" fill="white" fill-opacity="0.95"/>
                    <path d="M22 2 L32 2 L32 12 L22 12 Z" fill="#c7d2fe"/>
                    <line x1="7" y1="18" x2="27" y2="18" stroke="#a5b4fc" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="7" y1="26" x2="22" y2="26" stroke="#a5b4fc" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="7" y1="34" x2="17" y2="34" stroke="#a5b4fc" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
                <!-- Checkmark badge -->
                <div class="absolute -bottom-1 -right-1 w-7 h-7 bg-green-600 rounded-full flex items-center justify-center shadow-lg">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            </div>
            <h2 id="unlockTitle" class="text-2xl font-bold text-white mb-1">RegSecure AI</h2>
            <p class="text-slate-400 text-sm">Secure Contract Intelligence</p>
        </div>
        
        <!-- Initialization Progress (shown during load) -->
        <div id="initProgress" class="hidden mb-6">
            <div class="bg-slate-800 rounded-full h-1.5 mb-3 overflow-hidden">
                <div id="initProgressBar" class="bg-blue-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="initStatus" class="text-xs text-slate-400 text-center">Initializing secure environment...</p>
        </div>
        
        <div id="unlockForm">
            <!-- Secure Workspace Option -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">Master Password</label>
                <input type="password" id="masterPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="updatePasswordStrength()"
                    class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                <div id="passwordStrength" class="mt-2 hidden">
                    <div class="flex gap-1 mb-1">
                        <div id="strengthBar1" class="h-1 flex-1 rounded bg-slate-700"></div>
                        <div id="strengthBar2" class="h-1 flex-1 rounded bg-slate-700"></div>
                        <div id="strengthBar3" class="h-1 flex-1 rounded bg-slate-700"></div>
                        <div id="strengthBar4" class="h-1 flex-1 rounded bg-slate-700"></div>
                    </div>
                    <p id="strengthText" class="text-[10px] text-slate-500"></p>
                </div>
                <p id="passwordHint" class="mt-2 text-xs text-slate-500">First time? Create a secure password.</p>
            </div>
            
            <button onclick="unlockVault()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl transition mb-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                Launch Secure Workspace
            </button>
            
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-slate-700"></div>
                </div>
                <div class="relative flex justify-center text-xs">
                    <span class="bg-slate-900 px-3 text-slate-500">or explore first</span>
                </div>
            </div>
            
            <button onclick="loadDemoMode()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium py-2.5 rounded-xl transition mb-4 flex items-center justify-center gap-2 border border-slate-700 hover:border-blue-500/30">
                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span>Quick Start</span>
                <span class="text-[10px] text-slate-500 ml-1">(No signup)</span>
            </button>
            
            <!-- Trust Indicators -->
            <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-400">
                <div class="flex items-center gap-1.5 bg-slate-800/50 px-2.5 py-2 rounded-lg">
                    <svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    100% Local Processing
                </div>
                <div class="flex items-center gap-1.5 bg-slate-800/50 px-2.5 py-2 rounded-lg">
                    <svg class="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    AES-256 Encryption
                </div>
                <div class="flex items-center gap-1.5 bg-slate-800/50 px-2.5 py-2 rounded-lg">
                    <svg class="w-3.5 h-3.5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    On-Device AI
                </div>
                <div class="flex items-center gap-1.5 bg-slate-800/50 px-2.5 py-2 rounded-lg">
                    <svg class="w-3.5 h-3.5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    Zero Data Egress
                </div>
            </div>
        </div>
        
        <div id="unlockLoading" class="hidden text-center py-8">
            <div class="loader mx-auto mb-4" style="width: 32px; height: 32px;"></div>
            <p class="text-blue-400">Deriving encryption key...</p>
        </div>
    </div>
</div>

<!-- ========== MAIN APP ========== -->
<div id="mainApp" class="hidden h-full flex flex-col">
    
    <!-- HEADER -->
    <header class="border-b border-slate-800 px-4 py-3 bg-slate-900/80 backdrop-blur flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl flex items-center justify-center overflow-hidden">
                <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' class="w-9 h-9">
                  <defs>
                    <linearGradient id='logoGrad' x1='0%' y1='0%' x2='100%' y2='100%'>
                      <stop offset='0%' stop-color='#3b82f6'/>
                      <stop offset='100%' stop-color='#1d4ed8'/>
                    </linearGradient>
                  </defs>
                  <path d='M50 5 L90 20 L90 50 Q90 75 50 95 Q10 75 10 50 L10 20 Z' fill='url(#logoGrad)'/>
                  <rect x='30' y='25' width='40' height='50' rx='4' fill='white' fill-opacity='0.95'/>
                  <path d='M55 25 L70 25 L70 40 L55 40 Z' fill='#bfdbfe'/>
                  <line x1='37' y1='45' x2='63' y2='45' stroke='#93c5fd' stroke-width='3' stroke-linecap='round'/>
                  <line x1='37' y1='55' x2='57' y2='55' stroke='#93c5fd' stroke-width='3' stroke-linecap='round'/>
                  <line x1='37' y1='65' x2='50' y2='65' stroke='#93c5fd' stroke-width='3' stroke-linecap='round'/>
                  <circle cx='70' cy='68' r='14' fill='#16a34a'/>
                  <path d='M63 68 L68 73 L77 64' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/>
                </svg>
            </div>
            <div>
                <h1 class="text-sm font-bold text-white flex items-center gap-2">
                    RegSecure AI
                    
                </h1>
                <p class="text-[10px] text-slate-500">Contract Analysis ‚Ä¢ Secure Local AI</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- Unified System Status -->
            <div id="systemStatus" class="flex items-center gap-1.5 text-[10px] px-2.5 py-1 rounded-lg bg-slate-800 border border-slate-700 cursor-pointer" onclick="showSystemDetails()" title="Click for details">
                <div id="systemStatusDot" class="w-2 h-2 rounded-full bg-green-600"></div>
                <span id="systemStatusText" class="text-green-600">100% Local</span>
            </div>
            
            <!-- Privacy Monitor Button -->
            <button onclick="showPrivacyMonitor()" class="flex items-center gap-1.5 text-[10px] px-2.5 py-1 rounded-lg bg-slate-800 border border-slate-700 hover:border-green-500/50 hover:bg-slate-700 transition" title="Privacy Monitor - View Network Activity">
                <span class="text-green-500">üõ°Ô∏è</span>
                <span class="text-slate-400">Monitor</span>
            </button>
            
            <!-- Offline Indicator -->
            <div id="offlineIndicator" class="hidden flex items-center gap-1.5 text-[10px] px-2.5 py-1 rounded-lg bg-amber-500/20 border border-amber-500/30 text-amber-400">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3"/>
                </svg>
                <span>Offline Mode</span>
            </div>
            
            <!-- Hidden individual status for tracking -->
            <div id="workerStatus" class="hidden" data-ready="false"></div>
            <div id="ocrStatus" class="hidden" data-ready="false"></div>
            <div id="llmStatus" class="hidden" data-ready="false"></div>
            
            <button onclick="showFeedback()" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="Send Feedback">
                üí¨
            </button>
            <button onclick="showAbout()" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="About">
                ‚ÑπÔ∏è
            </button>
            <button onclick="toggleTheme()" id="themeToggle" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="Switch to Light Mode for document review">
                üåô
            </button>
            <button onclick="showDashboard()" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="Dashboard">
                üìä
            </button>
            <button onclick="printChat()" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="Print">
                üñ®Ô∏è
            </button>
            <button onclick="toggleHelp()" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="Help & Shortcuts">
                ‚ùì
            </button>
            <button onclick="showSettings()" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="Settings">
                ‚öôÔ∏è
            </button>
            <button onclick="lockVault()" class="text-xs text-slate-400 hover:text-white px-2 py-1 rounded-lg hover:bg-slate-800 transition" title="Lock">
                üîí
            </button>
        </div>
    </header>
    
    <div class="flex-1 flex overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-56 border-r border-slate-800 flex flex-col bg-slate-900/50">
            <div class="p-3 border-b border-slate-800">
                <button onclick="showUploadArea()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium py-2 rounded-xl transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Document
                </button>
                <div class="flex gap-2 mt-2">
                    <button onclick="showCompareMode()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-[10px] py-1.5 rounded-lg transition flex items-center justify-center gap-1">
                        ‚öñÔ∏è Compare
                    </button>
                    <button onclick="showClauseLibrary()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-[10px] py-1.5 rounded-lg transition flex items-center justify-center gap-1">
                        üìö Clauses
                    </button>
                </div>
                
                <!-- Sample Documents -->
                <div class="mt-3 pt-3 border-t border-slate-700">
                    <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider mb-2">Try Sample Contracts</p>
                    <div class="flex flex-wrap gap-1.5">
                        <button onclick="loadSampleDocument('nda')" class="text-[9px] bg-slate-800 hover:bg-blue-600 text-slate-400 hover:text-white px-2 py-1 rounded-md transition">
                            üìú NDA
                        </button>
                        <button onclick="loadSampleDocument('saas')" class="text-[9px] bg-slate-800 hover:bg-blue-600 text-slate-400 hover:text-white px-2 py-1 rounded-md transition">
                            ‚òÅÔ∏è SaaS
                        </button>
                        <button onclick="loadSampleDocument('dpa')" class="text-[9px] bg-slate-800 hover:bg-blue-600 text-slate-400 hover:text-white px-2 py-1 rounded-md transition">
                            üîê DPA
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar-thin p-3">
                <h3 class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider mb-2">Documents</h3>
                <div id="documentList" class="space-y-1">
                    <div class="text-center py-6">
                        <div class="w-12 h-12 bg-slate-800 rounded-xl flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <p class="text-xs text-slate-500 mb-1">No documents yet</p>
                        <p class="text-[10px] text-slate-600">Upload a contract or try a sample</p>
                    </div>
                </div>
            </div>
            
            <div class="p-3 border-t border-slate-800 text-[10px] text-slate-600 space-y-1">
                <div class="flex justify-between"><span>Documents:</span><span id="docCountStat">0</span></div>
                <!-- Technical stats hidden -->
                <span id="vectorCountStat" class="hidden">0</span>
                <span id="storageStat" class="hidden">0 KB</span>
            </div>
            
            <div class="p-3 border-t border-slate-800 flex gap-2">
                <button onclick="exportVault()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-[10px] text-slate-300 py-2 rounded-lg transition flex items-center justify-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Backup
                </button>
                <button onclick="document.getElementById('importInput').click()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-[10px] text-slate-300 py-2 rounded-lg transition flex items-center justify-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    Restore
                </button>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importVault(this.files[0])">
            </div>
        </aside>
        
        <!-- MAIN CONTENT -->
        <main class="flex-1 flex overflow-hidden">
            
            <!-- CENTRAL CONTENT AREA -->
            <section class="flex-1 flex flex-col">
                <!-- Header with Toggle -->
                <div class="px-4 py-2 border-b border-slate-800 bg-slate-900/30 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span id="currentDocName" class="text-sm text-slate-400">Select a document</span>
                        <span id="ocrBadge" class="hidden text-[9px] bg-blue-400/20 text-blue-300 px-1.5 py-0.5 rounded">OCR</span>
                        <span id="chunkBadge" class="hidden text-[9px] bg-blue-500/20 text-blue-300 px-1.5 py-0.5 rounded"></span>
                    </div>
                    
                    <!-- View Mode Toggle -->
                    <div id="viewToggle" class="hidden flex items-center bg-slate-800 rounded-lg p-0.5">
                        <button onclick="setViewMode('analysis')" id="btnAnalysis" class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition bg-blue-600 text-white">
                            <span>üí¨</span> Analysis
                        </button>
                        <button onclick="setViewMode('sections')" id="btnSections" class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition text-slate-400 hover:text-white">
                            <span>üìÑ</span> Sections
                        </button>
                    </div>
                </div>
                
                <!-- Selected Clause Indicator -->
                <div id="selectedClauseBar" class="hidden px-4 py-1.5 bg-blue-600/10 border-b border-blue-600/30 flex items-center justify-between">
                    <span class="text-xs text-blue-300">
                        <span class="opacity-60">Analyzing:</span> 
                        <span id="selectedClauseTitle" class="font-medium">Clause 1</span>
                    </span>
                    <button onclick="clearClauseSelection()" class="text-[10px] text-blue-400 hover:text-blue-300">Clear</button>
                </div>
                
                <!-- Main Content Area -->
                <div id="centralContent" class="flex-1 relative overflow-hidden">
                    
                    <!-- Upload Area (initial state) -->
                    <div id="uploadArea" class="absolute inset-0 flex flex-col items-center justify-center p-8">
                        <div id="dropZone" class="w-full max-w-md border-2 border-dashed border-slate-700 rounded-2xl p-10 text-center hover:border-blue-500/50 transition cursor-pointer">
                            <div class="w-14 h-14 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <svg class="w-7 h-7 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                            </div>
                            <h3 class="text-base font-semibold text-white mb-1">Drop document here</h3>
                            <p class="text-sm text-slate-500 mb-3">PDF, Word, or Excel</p>
                            <div class="flex flex-wrap justify-center gap-2">
                                <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded-full">üìÑ PDF</span>
                                <span class="text-[10px] bg-blue-500/10 text-blue-400 px-2 py-1 rounded-full">üìù Word</span>
                                <span class="text-[10px] bg-green-600/10 text-green-600 px-2 py-1 rounded-full">üìä Excel</span>
                                <span class="text-[10px] bg-blue-400/10 text-blue-300 px-2 py-1 rounded-full">üîç Scanned</span>
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.xlsx,.xls" class="hidden">
                    </div>
                    
                    <!-- Processing State -->
                    <div id="processingArea" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-950/95 p-8">
                        <div class="flex items-center gap-2 text-xs px-3 py-1.5 rounded-full bg-green-600/10 border border-green-600/30 text-green-600 mb-4">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            <span>Processing locally on your device</span>
                        </div>
                        <div class="relative w-32 h-32 mb-6">
                            <svg class="progress-ring w-full h-full">
                                <circle cx="64" cy="64" r="56" stroke="#1e293b" stroke-width="8" fill="none"/>
                                <circle id="progressRing" cx="64" cy="64" r="56" stroke="url(#gradient)" stroke-width="8" fill="none"
                                    stroke-dasharray="352" stroke-dashoffset="352" stroke-linecap="round"/>
                                <defs>
                                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#3b82f6"/>
                                        <stop offset="100%" style="stop-color:#3b82f6"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="progressPercent" class="text-2xl font-bold text-white">0%</span>
                            </div>
                        </div>
                        <p id="processingText" class="text-blue-400 font-medium mb-1">Analyzing Contract...</p>
                        <p id="processingSubtext" class="text-xs text-slate-500 mb-6">No data sent to external servers</p>
                        <div class="flex gap-2 flex-wrap justify-center max-w-md">
                            <span id="stageParse" class="stage-badge text-[10px] px-2 py-1 rounded-full border border-slate-700 text-slate-500">1. Parse</span>
                            <span id="stageOCR" class="stage-badge text-[10px] px-2 py-1 rounded-full border border-slate-700 text-slate-500">2. OCR</span>
                            <span id="stageSegment" class="stage-badge text-[10px] px-2 py-1 rounded-full border border-slate-700 text-slate-500">3. Segment</span>
                            <span id="stageEmbed" class="stage-badge text-[10px] px-2 py-1 rounded-full border border-slate-700 text-slate-500">4. Embed</span>
                            <span id="stageEncrypt" class="stage-badge text-[10px] px-2 py-1 rounded-full border border-slate-700 text-slate-500">5. Encrypt</span>
                        </div>
                    </div>
                    
                    <!-- SECTIONS VIEW (when viewMode = 'sections') -->
                    <div id="sectionsView" class="hidden absolute inset-0 overflow-y-auto p-4 scrollbar-thin">
                        <div id="sectionsGrid" class="grid gap-3"></div>
                    </div>
                    
                    <!-- ANALYSIS VIEW (when viewMode = 'analysis') - DEFAULT -->
                    <div id="analysisView" class="hidden absolute inset-0 flex flex-col">
                        <!-- Chat Messages -->
                        <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
                            <div class="flex gap-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-400 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/></svg>
                                </div>
                                <div class="flex-1 bg-slate-800/50 rounded-xl rounded-tl-sm px-4 py-3 border border-slate-700/50">
                                    <p class="text-sm text-slate-300">Upload a document or select a sample contract to begin analysis.</p>
                                    <div id="suggestionsArea" class="hidden mt-3 flex flex-wrap gap-2">
                                        <button onclick="summarizeDocument()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg">üìù Summarize</button>
                                        <button onclick="analyzeRisks()" class="text-xs bg-red-500/20 hover:bg-red-500/30 text-red-300 px-3 py-1.5 rounded-lg">üö® Risk Analysis</button>
                                        <button onclick="extractEntities()" class="text-xs bg-green-600/20 hover:bg-green-600/30 text-green-500 px-3 py-1.5 rounded-lg">üîç Extract Entities</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="p-3 border-t border-slate-800 bg-slate-900/50">
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="multiDocToggle" class="w-3.5 h-3.5 rounded border-slate-600 bg-slate-800 text-blue-500 focus:ring-blue-500 focus:ring-offset-0">
                            <span class="text-[10px] text-slate-400">Search all documents</span>
                        </label>
                        <span id="multiDocCount" class="hidden text-[10px] text-blue-400"></span>
                    </div>
                    <div class="relative">
                        <input type="text" id="chatInput" disabled placeholder="Ask about this document..."
                            class="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-4 pr-12 py-3 text-sm placeholder-slate-500 focus:outline-none focus:border-blue-500 disabled:opacity-50">
                        <button id="sendBtn" disabled onclick="handleChat()" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 rounded-lg flex items-center justify-center text-white transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- QUICK ACTIONS PANEL (Right Side) -->
            <aside class="w-64 border-l border-slate-800 flex flex-col bg-slate-900/30">
                <div class="px-3 py-2 border-b border-slate-800">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Quick Actions</span>
                </div>
                
                <div class="flex-1 overflow-y-auto p-3 space-y-4 scrollbar-thin">
                    <!-- Main Actions -->
                    <div class="space-y-2">
                        <button onclick="summarizeDocument()" class="w-full flex items-center gap-2 px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-600/30 rounded-lg text-blue-300 text-sm transition">
                            <span>üìù</span> Summarize
                        </button>
                        <button onclick="analyzeRisks()" class="w-full flex items-center gap-2 px-3 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-lg text-red-300 text-sm transition">
                            <span>üö®</span> Risk Analysis
                        </button>
                        <button onclick="extractEntities()" class="w-full flex items-center gap-2 px-3 py-2 bg-green-600/20 hover:bg-green-600/30 border border-green-600/30 rounded-lg text-green-500 text-sm transition">
                            <span>üîç</span> Extract Entities
                        </button>
                        <button onclick="askQuestion('What are the key terms?')" class="w-full flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-slate-300 text-sm transition">
                            <span>üìã</span> Key Terms
                        </button>
                    </div>
                    
                    <!-- Legal Templates -->
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-2">Legal Templates</p>
                        <div class="flex flex-wrap gap-1.5">
                            <button onclick="askQuestion('Summarize termination clauses')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded">Termination</button>
                            <button onclick="askQuestion('Summarize payment terms')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded">Payment</button>
                            <button onclick="askQuestion('Summarize confidentiality clauses')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded">Confidentiality</button>
                            <button onclick="askQuestion('Summarize liability clauses')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded">Liability</button>
                            <button onclick="askQuestion('What is the jurisdiction?')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded">Jurisdiction</button>
                            <button onclick="askQuestion('Summarize indemnification clauses')" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-2 py-1 rounded">Indemnification</button>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-2">Export</p>
                        <div class="space-y-1.5">
                            <button onclick="exportPDFReport()" class="w-full flex items-center gap-2 px-2 py-1.5 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 text-xs">
                                <span>üìÑ</span> PDF Report
                            </button>
                            <button onclick="exportSummary()" class="w-full flex items-center gap-2 px-2 py-1.5 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 text-xs">
                                <span>üí¨</span> Export Chat
                            </button>
                            <button onclick="exportAuditLog()" class="w-full flex items-center gap-2 px-2 py-1.5 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 text-xs">
                                <span>üìã</span> Audit Log
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>
</div>

<!-- ========== COMPARE MODAL ========== -->
<div id="compareModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-4xl w-full mx-4 border border-slate-800 shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white">‚öñÔ∏è Compare Documents</h2>
            <button onclick="closeCompareModal()" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-xs text-slate-400 mb-2">Document 1</label>
                <select id="compareDoc1" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                    <option value="">Select document...</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-2">Document 2</label>
                <select id="compareDoc2" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                    <option value="">Select document...</option>
                </select>
            </div>
        </div>
        <button onclick="runComparison()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg mb-4">Compare</button>
        <div id="compareResults" class="hidden">
            <div class="grid grid-cols-2 gap-4">
                <div id="compareLeft" class="bg-slate-800/50 rounded-lg p-3 max-h-[400px] overflow-y-auto text-xs"></div>
                <div id="compareRight" class="bg-slate-800/50 rounded-lg p-3 max-h-[400px] overflow-y-auto text-xs"></div>
            </div>
            <div id="compareSummary" class="mt-4 p-3 bg-slate-800/50 rounded-lg text-sm"></div>
        </div>
    </div>
</div>

<!-- ========== CLAUSE LIBRARY MODAL ========== -->
<div id="clauseModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-2xl w-full mx-4 border border-slate-800 shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white">üìö Clause Library</h2>
            <button onclick="closeClauseModal()" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <div class="mb-4">
            <button onclick="saveCurrentSelection()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg">+ Save Selected Text</button>
            <span class="text-xs text-slate-500 ml-2">(Select text in a chunk first)</span>
        </div>
        <div id="clauseList" class="space-y-2">
            <p class="text-slate-500 text-sm text-center py-8">No saved clauses yet</p>
        </div>
    </div>
</div>

<!-- ========== DASHBOARD MODAL ========== -->
<div id="dashboardModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-2xl w-full mx-4 border border-slate-800 shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white">üìä Usage Dashboard</h2>
            <button onclick="closeDashboard()" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                <p class="text-3xl font-bold text-blue-400" id="dashTotalDocs">0</p>
                <p class="text-xs text-slate-500">Documents</p>
            </div>
            <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                <p class="text-3xl font-bold text-blue-300" id="dashTotalQueries">0</p>
                <p class="text-xs text-slate-500">Queries</p>
            </div>
            <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                <p class="text-3xl font-bold text-green-600" id="dashSessionTime">0m</p>
                <p class="text-xs text-slate-500">Session Time</p>
            </div>
        </div>
        <div class="bg-slate-800/50 rounded-xl p-4 mb-4">
            <h3 class="text-sm font-semibold text-white mb-3">Recent Activity</h3>
            <div id="dashRecentActivity" class="space-y-2 max-h-[200px] overflow-y-auto text-xs"></div>
        </div>
        <div class="bg-slate-800/50 rounded-xl p-4">
            <h3 class="text-sm font-semibold text-white mb-3">Document Stats</h3>
            <div id="dashDocStats" class="space-y-2 text-xs"></div>
        </div>
    </div>
</div>

<!-- ========== SETTINGS MODAL ========== -->
<div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full mx-4 border border-slate-800 shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white">‚öôÔ∏è Settings</h2>
            <button onclick="closeSettings()" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        
        <div class="space-y-4">
            <!-- Change Password -->
            <div class="bg-slate-800/50 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-white mb-3">üîê Change Password</h3>
                <input type="password" id="currentPassword" placeholder="Current password" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white mb-2">
                <input type="password" id="newPassword" placeholder="New password" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white mb-2">
                <input type="password" id="confirmPassword" placeholder="Confirm new password" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white mb-2">
                <button onclick="changePassword()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg text-sm">Change Password</button>
            </div>
            
            <!-- Duress Password -->
            <div class="bg-slate-800/50 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-white mb-2">üö® Duress Password</h3>
                <p class="text-[10px] text-slate-500 mb-3">Emergency password that wipes all data when entered</p>
                <input type="password" id="duressPassword" placeholder="Set duress password" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white mb-2">
                <button onclick="setDuressPassword()" class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg text-sm">Set Duress Password</button>
            </div>
            
            <!-- Session Timeout -->
            <div class="bg-slate-800/50 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-white mb-3">‚è±Ô∏è Session Timeout</h3>
                <select id="timeoutSelect" onchange="updateTimeout()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                    <option value="5">5 minutes</option>
                    <option value="15" selected>15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="0">Never</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- ========== DOCUMENT STATS MODAL ========== -->
<div id="statsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full mx-4 border border-slate-800 shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white">üìÑ Document Stats</h2>
            <button onclick="closeStatsModal()" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <div id="statsContent" class="space-y-3"></div>
    </div>
</div>

<!-- ========== ONBOARDING TOUR MODAL ========== -->
<div id="tourModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop hidden">
    <div class="bg-slate-900 rounded-2xl p-8 max-w-md w-full mx-4 border border-slate-700 shadow-2xl relative overflow-hidden">
        <!-- Background Decoration -->
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-green-500"></div>
        
        <div id="tourStep1" class="tour-step">
            <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mb-4 text-2xl">üîí</div>
            <h2 class="text-xl font-bold text-white mb-2">The Only AI That Stays Local</h2>
            <p class="text-slate-400 text-sm mb-6 leading-relaxed">
                RegSecure runs <strong class="text-green-400">100% in your browser</strong>.<br><br>
                No cloud. No uploads. Your contracts never leave your device.
            </p>
            <button onclick="nextTourStep(2)" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 rounded-xl transition">See How ‚Üí</button>
        </div>

        <div id="tourStep2" class="tour-step hidden">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center mb-4 text-2xl">‚ö°</div>
            <h2 class="text-xl font-bold text-white mb-2">Instant Safety Score</h2>
            <p class="text-slate-400 text-sm mb-6 leading-relaxed">
                Drop a contract and get a <strong class="text-amber-400">Safety Score (0-10)</strong> in seconds.<br><br>
                Every risky clause flagged with severity and recommendations.
            </p>
            <button onclick="nextTourStep(3)" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-medium py-2.5 rounded-xl transition">Next ‚Üí</button>
        </div>

        <div id="tourStep3" class="tour-step hidden">
            <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mb-4 text-2xl">üõ°Ô∏è</div>
            <h2 class="text-xl font-bold text-white mb-2">Trust, But Verify</h2>
            <p class="text-slate-400 text-sm mb-6 leading-relaxed">
                Click <strong class="text-green-400">Privacy Monitor</strong> to watch network activity live.<br><br>
                Zero bytes sent. See it with your own eyes.
            </p>
            <button onclick="nextTourStep(4)" class="w-full bg-green-600 hover:bg-green-500 text-white font-medium py-2.5 rounded-xl transition">Next ‚Üí</button>
        </div>

        <div id="tourStep4" class="tour-step hidden">
            <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mb-4 text-2xl">üí¨</div>
            <h2 class="text-xl font-bold text-white mb-2">Chat & Export</h2>
            <p class="text-slate-400 text-sm mb-6 leading-relaxed">
                Ask anything about your contract in plain English.<br><br>
                Export findings to <strong class="text-blue-300">PDF</strong> for your next meeting.
            </p>
            <button onclick="closeTour()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 rounded-xl transition">Get Started üöÄ</button>
        </div>
        
        <div class="mt-6 flex justify-center gap-2">
            <div class="w-2 h-2 rounded-full bg-slate-700 tour-dot transition-all" id="dot1"></div>
            <div class="w-2 h-2 rounded-full bg-slate-700 tour-dot transition-all" id="dot2"></div>
            <div class="w-2 h-2 rounded-full bg-slate-700 tour-dot transition-all" id="dot3"></div>
            <div class="w-2 h-2 rounded-full bg-slate-700 tour-dot transition-all" id="dot4"></div>
        </div>
        
        <button onclick="closeTour()" class="absolute top-4 right-4 text-slate-500 hover:text-white text-sm">Skip</button>
    </div>
</div>

<!-- ========== HELP MODAL ========== -->
<div id="helpModal" class="fixed inset-0 z-[70] flex items-center justify-center modal-backdrop hidden" onclick="toggleHelp()">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-lg w-full mx-4 border border-slate-700 shadow-2xl fade-in" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-5">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">‚ùì</span>
                Help & Shortcuts
            </h2>
            <button onclick="toggleHelp()" class="text-slate-400 hover:text-white text-xl">‚úï</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Keyboard Shortcuts -->
            <div class="space-y-3">
                <h3 class="text-xs font-semibold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                    <span>‚å®Ô∏è</span> Keyboard Shortcuts
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center py-1 border-b border-slate-800">
                        <span class="text-slate-400">Search / Chat</span>
                        <kbd class="bg-slate-800 text-blue-300 px-2 py-0.5 rounded text-xs font-mono">Ctrl+K</kbd>
                    </div>
                    <div class="flex justify-between items-center py-1 border-b border-slate-800">
                        <span class="text-slate-400">New Document</span>
                        <kbd class="bg-slate-800 text-blue-300 px-2 py-0.5 rounded text-xs font-mono">Ctrl+N</kbd>
                    </div>
                    <div class="flex justify-between items-center py-1 border-b border-slate-800">
                        <span class="text-slate-400">Lock Vault</span>
                        <kbd class="bg-slate-800 text-blue-300 px-2 py-0.5 rounded text-xs font-mono">Ctrl+L</kbd>
                    </div>
                    <div class="flex justify-between items-center py-1 border-b border-slate-800">
                        <span class="text-slate-400">Backup</span>
                        <kbd class="bg-slate-800 text-blue-300 px-2 py-0.5 rounded text-xs font-mono">Ctrl+B</kbd>
                    </div>
                    <div class="flex justify-between items-center py-1 border-b border-slate-800">
                        <span class="text-slate-400">Export Chat</span>
                        <kbd class="bg-slate-800 text-blue-300 px-2 py-0.5 rounded text-xs font-mono">Ctrl+E</kbd>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-slate-400">Switch Document</span>
                        <kbd class="bg-slate-800 text-blue-300 px-2 py-0.5 rounded text-xs font-mono">Ctrl+1-9</kbd>
                    </div>
                </div>
            </div>
            
            <!-- Features Guide -->
            <div class="space-y-3">
                <h3 class="text-xs font-semibold text-blue-300 uppercase tracking-wider flex items-center gap-2">
                    <span>üöÄ</span> Features Guide
                </h3>
                <div class="space-y-2 text-xs text-slate-400 leading-relaxed">
                    <div class="p-2 bg-slate-800/50 rounded-lg">
                        <span class="text-white font-medium">üìÑ Multi-Doc Search:</span><br>
                        Toggle "Search all docs" to query across your entire vault.
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded-lg">
                        <span class="text-white font-medium">‚ö†Ô∏è Risk Analysis:</span><br>
                        Finds liability, indemnification, and termination clauses.
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded-lg">
                        <span class="text-white font-medium">üîç OCR:</span><br>
                        Automatically reads scanned documents.
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded-lg">
                        <span class="text-white font-medium">‚öñÔ∏è Compare:</span><br>
                        Select 2 documents to see side-by-side differences.
                    </div>
                    <div class="p-2 bg-slate-800/50 rounded-lg">
                        <span class="text-white font-medium">üñ®Ô∏è Print:</span><br>
                        Use print button for clean PDF export of chat.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex gap-2 pt-4 border-t border-slate-800">
            <button onclick="resetTour(); toggleHelp();" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm py-2 rounded-xl transition">
                üéì Restart Tour
            </button>
            <button onclick="toggleHelp()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm py-2 rounded-xl transition">
                Got it!
            </button>
        </div>
        
        <div class="text-center text-[10px] text-slate-600 mt-4">
            RegSecure AI Pro ‚Ä¢ v1.0 Beta ‚Ä¢ Patent pending
        </div>
    </div>
</div>

<!-- ========== ABOUT MODAL ========== -->
<div id="aboutModal" class="fixed inset-0 z-[80] flex items-center justify-center modal-backdrop hidden" onclick="hideAbout()">
    <div class="bg-slate-900 rounded-2xl p-8 max-w-md w-full mx-4 border border-slate-700 shadow-2xl fade-in" onclick="event.stopPropagation()">
        <div class="text-center mb-6">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-600/15 relative">
                <svg class="w-10 h-10" viewBox="0 0 40 50" fill="none">
                    <rect x="2" y="2" width="30" height="40" rx="3" fill="white" fill-opacity="0.95"/>
                    <path d="M22 2 L32 2 L32 12 L22 12 Z" fill="#c7d2fe"/>
                    <line x1="7" y1="18" x2="27" y2="18" stroke="#a5b4fc" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="7" y1="26" x2="22" y2="26" stroke="#a5b4fc" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="7" y1="34" x2="17" y2="34" stroke="#a5b4fc" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
                <div class="absolute -bottom-1 -right-1 w-7 h-7 bg-green-600 rounded-full flex items-center justify-center shadow-lg">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-white mb-1">RegSecure AI Pro</h2>
            <p class="text-slate-400 text-sm">Secure Contract Intelligence</p>
        </div>
        
        <div class="space-y-3 mb-6">
            <div class="flex justify-between items-center py-2 border-b border-slate-800">
                <span class="text-slate-400 text-sm">Version</span>
                <span class="text-white text-sm font-mono">1.0.2 Beta</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-800">
                <span class="text-slate-400 text-sm">Patent</span>
                <span class="text-blue-400 text-sm font-mono">US 19/428,113 (Pending)</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-800">
                <span class="text-slate-400 text-sm">Processing</span>
                <span class="text-green-600 text-sm">100% Local</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-slate-800">
                <span class="text-slate-400 text-sm">Encryption</span>
                <span class="text-blue-300 text-sm">AES-256-GCM</span>
            </div>
            <div class="flex justify-between items-center py-2">
                <span class="text-slate-400 text-sm">Developer</span>
                <span class="text-white text-sm">Particular Ltd</span>
            </div>
        </div>
        
        <div class="flex gap-2">
            <a href="/cdn-cgi/l/email-protection#afceddc1c0c1efdfcedddbc6ccdac3cedd81ccc081c6c3" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm py-2.5 rounded-xl transition text-center">
                ‚úâÔ∏è Contact Support
            </a>
            <button onclick="hideAbout()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm py-2.5 rounded-xl transition">
                Close
            </button>
        </div>
        
        <p class="text-center text-[10px] text-slate-600 mt-4">
            ¬© Particular Ltd. All rights reserved.
        </p>
    </div>
</div>

<!-- ========== SYSTEM DETAILS MODAL ========== -->
<div id="systemDetailsModal" class="fixed inset-0 z-[80] flex items-center justify-center modal-backdrop hidden" onclick="hideSystemDetails()">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-sm w-full mx-4 border border-slate-700 shadow-2xl fade-in" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center">‚öôÔ∏è</span>
                System Status
            </h2>
            <button onclick="hideSystemDetails()" class="text-slate-400 hover:text-white text-xl">‚úï</button>
        </div>
        
        <div class="space-y-3">
            <div id="detailWorker" class="flex items-center justify-between py-2 px-3 rounded-lg bg-slate-800/50">
                <span class="text-slate-300 text-sm flex items-center gap-2">
                    <span>üîß</span> Processing Engine
                </span>
                <span class="text-yellow-400 text-xs">Loading...</span>
            </div>
            <div id="detailOCR" class="flex items-center justify-between py-2 px-3 rounded-lg bg-slate-800/50">
                <span class="text-slate-300 text-sm flex items-center gap-2">
                    <span>üì∑</span> OCR Engine
                </span>
                <span class="text-yellow-400 text-xs">Loading...</span>
            </div>
            <div id="detailLLM" class="flex items-center justify-between py-2 px-3 rounded-lg bg-slate-800/50">
                <span class="text-slate-300 text-sm flex items-center gap-2">
                    <span>üß†</span> AI Model
                </span>
                <div class="flex items-center gap-2">
                    <span class="text-yellow-400 text-xs">Loading...</span>
                    <button onclick="retryLLM(); hideSystemDetails();" class="text-[10px] bg-blue-600 hover:bg-blue-500 text-white px-2 py-0.5 rounded">Retry</button>
                </div>
            </div>
            
            <!-- Quick Start Mode Toggle -->
            <div class="flex items-center justify-between py-2 px-3 rounded-lg bg-blue-600/10 border border-blue-600/30">
                <label for="embeddingOnlyMode" class="text-slate-300 text-sm flex items-center gap-2 cursor-pointer">
                    <span>‚ö°</span> Quick Start Mode
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-slate-500">No AI download</span>
                    <input type="checkbox" id="embeddingOnlyMode" class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-500" />
                </div>
            </div>
            
            <div id="detailEncryption" class="flex items-center justify-between py-2 px-3 rounded-lg bg-slate-800/50">
                <span class="text-slate-300 text-sm flex items-center gap-2">
                    <span>üîí</span> Encryption
                </span>
                <span class="text-green-600 text-xs">AES-256 Active</span>
            </div>
        </div>
        
        <button onclick="hideSystemDetails()" class="w-full mt-4 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm py-2 rounded-xl transition">
            Close
        </button>
    </div>
</div>

<!-- ========== FEEDBACK MODAL ========== -->
<div id="feedbackModal" class="fixed inset-0 z-[80] flex items-center justify-center modal-backdrop hidden" onclick="hideFeedback()">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full mx-4 border border-slate-700 shadow-2xl fade-in" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">üí¨</span>
                Send Feedback
            </h2>
            <button onclick="hideFeedback()" class="text-slate-400 hover:text-white text-xl">‚úï</button>
        </div>
        
        <p class="text-sm text-slate-400 mb-4">Help us improve RegSecure AI. Your feedback shapes the product.</p>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">What type of feedback?</label>
            <div class="flex gap-2">
                <button onclick="setFeedbackType('bug')" id="fbTypeBug" class="flex-1 text-xs py-2 rounded-lg bg-slate-800 hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition border border-slate-700 hover:border-red-500/30">
                    üêõ Bug
                </button>
                <button onclick="setFeedbackType('feature')" id="fbTypeFeature" class="flex-1 text-xs py-2 rounded-lg bg-slate-800 hover:bg-blue-500/20 text-slate-400 hover:text-blue-400 transition border border-slate-700 hover:border-blue-500/30">
                    ‚ú® Feature
                </button>
                <button onclick="setFeedbackType('other')" id="fbTypeOther" class="flex-1 text-xs py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition border border-slate-700">
                    üí≠ Other
                </button>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">Your feedback</label>
            <textarea id="feedbackText" rows="4" placeholder="Describe your feedback..." class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white text-sm placeholder-slate-500 focus:outline-none focus:border-blue-500 resize-none"></textarea>
        </div>
        
        <div class="flex gap-2">
            <button onclick="hideFeedback()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm py-2.5 rounded-xl transition">
                Cancel
            </button>
            <button onclick="submitFeedback()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm py-2.5 rounded-xl transition">
                Send Feedback
            </button>
        </div>
    </div>
</div>

<!-- ========== PRIVACY MONITOR MODAL ========== -->
<div id="privacyMonitorModal" class="fixed inset-0 z-[80] flex items-center justify-center modal-backdrop hidden" onclick="hidePrivacyMonitor()">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-lg w-full mx-4 border border-green-500/30 shadow-2xl fade-in" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center">üõ°Ô∏è</span>
                Privacy Monitor
            </h2>
            <button onclick="hidePrivacyMonitor()" class="text-slate-400 hover:text-white text-xl">‚úï</button>
        </div>
        
        <!-- Status Banner -->
        <div id="privacyStatus" class="flex items-center gap-3 p-3 rounded-xl bg-green-500/10 border border-green-500/30 mb-4">
            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
            <div>
                <div class="text-green-400 font-semibold text-sm">OFFLINE ISOLATION ACTIVE</div>
                <div class="text-green-600 text-xs">No document data leaving device</div>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-3 gap-3 mb-4">
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <div id="privacyOutbound" class="text-2xl font-bold text-green-400">0</div>
                <div class="text-[10px] text-slate-500">Bytes Sent</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <div id="privacyBlocked" class="text-2xl font-bold text-green-400">0</div>
                <div class="text-[10px] text-slate-500">Blocked</div>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <div id="privacyLocal" class="text-2xl font-bold text-blue-400">0</div>
                <div class="text-[10px] text-slate-500">Local Ops</div>
            </div>
        </div>
        
        <!-- Activity Log -->
        <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Network Activity Log</span>
                <button onclick="clearPrivacyLog()" class="text-[10px] text-slate-500 hover:text-white">Clear</button>
            </div>
            <div id="privacyLog" class="bg-slate-950 rounded-lg p-3 h-48 overflow-y-auto font-mono text-xs space-y-1 scrollbar-thin">
                <div class="text-slate-600 italic">Monitoring network activity...</div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="flex flex-wrap gap-3 text-[10px] text-slate-500">
            <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                <span>Local operation</span>
            </div>
            <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                <span>Allowed (CDN/fonts)</span>
            </div>
            <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                <span>Blocked</span>
            </div>
        </div>
        
        <!-- Info -->
        <p class="text-slate-500 text-[10px] mt-4 leading-relaxed">
            This monitor tracks all network activity. Document analysis, AI inference, and chat responses happen 100% locally ‚Äî zero data sent to external servers.
            <a href="#" onclick="event.preventDefault(); alert('Open DevTools > Network tab to verify independently.')" class="text-blue-400 hover:underline">Verify yourself ‚Üí</a>
        </p>
    </div>
</div>

<!-- ========== ERROR MODAL ========== -->
<div id="errorModal" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden" onclick="hideError()">
    <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full mx-4 border border-red-500/30 shadow-2xl fade-in" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center">‚ö†Ô∏è</span>
                <span id="errorTitle">Error</span>
            </h2>
            <button onclick="hideError()" class="text-slate-400 hover:text-white text-xl">‚úï</button>
        </div>
        
        <p id="errorMessage" class="text-slate-400 text-sm mb-4">An error occurred.</p>
        
        <div id="errorDetails" class="hidden bg-slate-800/50 rounded-lg p-3 mb-4 text-xs text-slate-500 font-mono max-h-32 overflow-auto"></div>
        
        <div id="errorActions" class="flex gap-2">
            <button onclick="hideError()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm py-2.5 rounded-xl transition">
                Dismiss
            </button>
            <button onclick="location.reload()" class="flex-1 bg-red-600 hover:bg-red-500 text-white text-sm py-2.5 rounded-xl transition">
                Reload Page
            </button>
        </div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ==========================================
// TOAST NOTIFICATIONS
// ==========================================
const showToast = (message, type = 'info') => {
    const el = document.createElement('div');
    el.className = `px-4 py-3 rounded-lg text-sm text-white shadow-xl backdrop-blur border border-white/10 flex items-center gap-2 toast-enter pointer-events-auto ${
        type === 'error' ? 'bg-red-500/90' : 
        type === 'success' ? 'bg-green-600/90' : 
        'bg-slate-800/90'}`;
    
    const icon = type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
    el.innerHTML = `<span>${icon}</span><span>${message}</span>`;
    
    document.getElementById('toastContainer').appendChild(el);
    setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateX(100%)';
        el.style.transition = 'all 0.3s';
        setTimeout(() => el.remove(), 300);
    }, 3000);
};

// ==========================================
// CRYPTO UTILITIES
// ==========================================
const Crypto = {
    SALT_LENGTH: 16,
    IV_LENGTH: 12,
    
    async deriveKey(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
            keyMaterial,
            { name: 'AES-GCM', length: 256 },
            false,
            ['encrypt', 'decrypt']
        );
    },
    
    async encrypt(data, key) {
        const iv = crypto.getRandomValues(new Uint8Array(this.IV_LENGTH));
        const encoded = new TextEncoder().encode(JSON.stringify(data));
        const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
        const combined = new Uint8Array(iv.length + encrypted.byteLength);
        combined.set(iv);
        combined.set(new Uint8Array(encrypted), iv.length);
        return combined;
    },
    
    async decrypt(combined, key) {
        const iv = combined.slice(0, this.IV_LENGTH);
        const data = combined.slice(this.IV_LENGTH);
        const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
        return JSON.parse(new TextDecoder().decode(decrypted));
    }
};

// ==========================================
// INDEXED DB
// ==========================================
const DB = {
    name: 'RegSecureUltimate',
    version: 1,
    db: null,
    
    async init() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(this.name, this.version);
            req.onerror = () => reject(req.error);
            req.onsuccess = () => { this.db = req.result; resolve(); };
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('documents')) db.createObjectStore('documents', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('vectors')) {
                    const store = db.createObjectStore('vectors', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('docId', 'docId');
                }
                if (!db.objectStoreNames.contains('conversations')) db.createObjectStore('conversations', { keyPath: 'docId' });
                if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
            };
        });
    },
    
    async get(store, key) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readonly');
            const req = tx.objectStore(store).get(key);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },
    
    async put(store, data) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            const req = tx.objectStore(store).put(data);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    },
    
    async getAll(store) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readonly');
            const req = tx.objectStore(store).getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },
    
    async delete(store, key) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            const req = tx.objectStore(store).delete(key);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    },
    
    async getByIndex(store, indexName, value) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readonly');
            const req = tx.objectStore(store).index(indexName).getAll(value);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },
    
    async deleteByIndex(store, indexName, value) {
        const items = await this.getByIndex(store, indexName, value);
        const tx = this.db.transaction(store, 'readwrite');
        items.forEach(i => tx.objectStore(store).delete(i.id));
        return new Promise(r => tx.oncomplete = r);
    }
};

// ==========================================
// APPLICATION STATE
// ==========================================
const state = {
    encryptionKey: null,
    salt: null,
    
    embeddingPipeline: null,
    embeddingWorker: null,
    llmEngine: null,
    ocrWorker: null,
    
    isEmbeddingReady: false,
    isLLMReady: false,
    isOCRReady: false,
    
    currentDocId: null,
    currentChunks: [],
    documents: [],
    
    isProcessing: false,
    
    // View mode: 'analysis' (default) or 'sections'
    viewMode: 'analysis',
    selectedClauseIndex: null,
    
    // Session management
    lastActivity: Date.now(),
    sessionTimeout: 15 * 60 * 1000, // 15 minutes
    sessionTimer: null,
    
    // Audit log
    auditLog: [],
    
    // Last risk analysis results
    lastRiskAnalysis: null,
    
    // Demo mode
    isDemoMode: false
};

// ==========================================
// WEB WORKER FOR EMBEDDINGS
// ==========================================
function initEmbeddingWorker() {
    // Create inline worker
    const workerCode = `
        let pipeline = null;
        
        self.onmessage = async (e) => {
            if (e.data.type === 'init') {
                try {
                    const { pipeline: createPipeline } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1');
                    pipeline = await createPipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { quantized: true });
                    self.postMessage({ type: 'ready' });
                } catch (err) {
                    self.postMessage({ type: 'error', error: err.message });
                }
            }
            
            if (e.data.type === 'embed') {
                try {
                    const output = await pipeline(e.data.text, { pooling: 'mean', normalize: true });
                    self.postMessage({ 
                        type: 'embedding', 
                        index: e.data.index, 
                        embedding: Array.from(output.data),
                        total: e.data.total
                    });
                } catch (err) {
                    self.postMessage({ type: 'error', error: err.message, index: e.data.index });
                }
            }
        };
    `;
    
    try {
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        state.embeddingWorker = new Worker(URL.createObjectURL(blob), { type: 'module' });
        
        state.embeddingWorker.onmessage = (e) => {
            if (e.data.type === 'ready') {
                state.isEmbeddingReady = true;
                updateStatus('workerStatus', 'ready', 'Worker ‚úì');
                console.log('‚úÖ Embedding Worker ready');
            }
            if (e.data.type === 'error') {
                console.error('Worker error:', e.data.error);
                // Fallback to main thread
                initMainThreadEmbedding();
            }
        };
        
        state.embeddingWorker.postMessage({ type: 'init' });
        
    } catch (err) {
        console.warn('Worker failed, using main thread:', err);
        initMainThreadEmbedding();
    }
}

async function initMainThreadEmbedding() {
    // Fallback when workers don't work
    window.addEventListener('transformers-ready', async () => {
        try {
            state.embeddingPipeline = await window.TransformersJS.pipeline(
                'feature-extraction', 
                'Xenova/all-MiniLM-L6-v2', 
                { quantized: true }
            );
            state.isEmbeddingReady = true;
            updateStatus('workerStatus', 'ready', 'Embed ‚úì');
            console.log('‚úÖ Main thread embedding ready');
        } catch (e) {
            updateStatus('workerStatus', 'error', 'Error');
        }
    });
}

// ==========================================
// OCR INITIALIZATION
// ==========================================
async function initOCR() {
    try {
        // Support English OCR
        state.ocrWorker = await Tesseract.createWorker('eng', 1, {
            logger: m => {
                if (m.status === 'recognizing text') {
                    const pct = Math.round(m.progress * 100);
                    updateProcessing(`OCR: ${pct}%`, `Processing page (EN+HE)`, 20 + pct * 0.3);
                }
            }
        });
        state.isOCRReady = true;
        updateStatus('ocrStatus', 'ready', 'OCR ‚úì (EN+HE)');
        console.log('‚úÖ Tesseract OCR ready (English)');
    } catch (e) {
        console.error('OCR init error:', e);
        updateStatus('ocrStatus', 'error', 'OCR Error');
    }
}

// ==========================================
// VAULT MANAGEMENT
// ==========================================
async function unlockVault() {
    const password = document.getElementById('masterPassword').value;
    if (!password || password.length < 4) { showToast('Min 4 characters', 'error'); return; }
    
    document.getElementById('unlockForm').classList.add('hidden');
    document.getElementById('unlockLoading').classList.remove('hidden');
    
    try {
        await DB.init();
        
        let meta = await DB.get('meta', 'salt');
        if (!meta) {
            state.salt = crypto.getRandomValues(new Uint8Array(Crypto.SALT_LENGTH));
            await DB.put('meta', { key: 'salt', value: Array.from(state.salt) });
        } else {
            state.salt = new Uint8Array(meta.value);
        }
        
        state.encryptionKey = await Crypto.deriveKey(password, state.salt);
        
        try {
            await loadDocuments();
        } catch (e) {
            if (e.name === 'OperationError') {
                showToast('Wrong password', 'error');
                document.getElementById('unlockForm').classList.remove('hidden');
                document.getElementById('unlockLoading').classList.add('hidden');
                return;
            }
        }
        
        document.getElementById('unlockModal').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        // Initialize workers
        initEmbeddingWorker();
        initOCR();
        initLLM();
        
        updateStats();
        
    } catch (e) {
        console.error(e);
        showToast('Error: ' + e.message, 'error');
        document.getElementById('unlockForm').classList.remove('hidden');
        document.getElementById('unlockLoading').classList.add('hidden');
    }
}

function lockVault() {
    state.encryptionKey = null;
    state.currentDocId = null;
    state.currentChunks = [];
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('unlockModal').classList.remove('hidden');
    document.getElementById('unlockForm').classList.remove('hidden');
    document.getElementById('unlockLoading').classList.add('hidden');
    document.getElementById('masterPassword').value = '';
}

// ==========================================
// DOCUMENT PROCESSING (PDF, Word, Excel, OCR)
// ==========================================
async function processDocument(file) {
    if (!state.isEmbeddingReady) {
        showToast('Please wait for embedding model to load', 'info');
        return;
    }
    
    document.getElementById('uploadArea').classList.add('hidden');
    document.getElementById('processingArea').classList.remove('hidden');
    resetStages();
    
    const docId = 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const fileName = file.name.toLowerCase();
    let textChunks = [];
    let fileType = 'unknown';
    let needsOCR = false;
    
    try {
        const buffer = await file.arrayBuffer();
        
        // === DETECT FILE TYPE & PARSE ===
        setStage('stageParse', 'active');
        
        if (fileName.endsWith('.pdf')) {
            // ===== PDF PROCESSING =====
            fileType = 'pdf';
            updateProcessing('Parsing PDF...', 'Loading document', 5);
            
            const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
            const pageCount = Math.min(pdf.numPages, 20);
            
            let allText = [];
            let allItems = [];
            
            for (let i = 1; i <= pageCount; i++) {
                updateProcessing(`Reading page ${i}/${pageCount}`, 'Extracting text', 5 + (i / pageCount) * 15);
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                
                const pageText = content.items.map(item => item.str).join(' ').trim();
                allText.push(pageText);
                
                allItems.push(...content.items.map(item => ({
                    str: item.str,
                    x: item.transform[4],
                    y: item.transform[5],
                    height: item.height || 10
                })));
            }
            
            const totalText = allText.join('').trim();
            needsOCR = totalText.length < 100;
            
            setStage('stageParse', 'done');
            
            if (needsOCR) {
                // OCR for scanned PDFs
                setStage('stageOCR', 'active');
                updateProcessing('Running OCR...', 'Scanned document detected', 20);
                
                if (!state.isOCRReady) await initOCR();
                
                const ocrTexts = [];
                for (let i = 1; i <= pageCount; i++) {
                    updateProcessing(`OCR page ${i}/${pageCount}`, 'Recognizing text', 20 + (i / pageCount) * 30);
                    
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    
                    const { data: { text } } = await state.ocrWorker.recognize(canvas);
                    ocrTexts.push(text);
                }
                
                textChunks = ocrTexts.join('\n\n').split(/\n\n+/).filter(t => t.trim().length > 30);
                setStage('stageOCR', 'done');
            } else {
                setStage('stageOCR', 'done');
                setStage('stageSegment', 'active');
                updateProcessing('Segmenting...', 'Paragraph detection', 50);
                textChunks = segmentDocument(allItems);
                setStage('stageSegment', 'done');
            }
            
        } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
            // ===== WORD PROCESSING =====
            fileType = 'word';
            updateProcessing('Parsing Word document...', 'Extracting text', 10);
            
            const result = await mammoth.extractRawText({ arrayBuffer: buffer });
            const text = result.value;
            
            setStage('stageParse', 'done');
            setStage('stageOCR', 'done'); // Skip OCR
            setStage('stageSegment', 'active');
            updateProcessing('Segmenting...', 'Splitting paragraphs', 40);
            
            // Split by double newlines or long single newlines
            textChunks = text.split(/\n\s*\n+/)
                .map(t => t.trim())
                .filter(t => t.length > 30);
            
            // If too few chunks, split by single newlines
            if (textChunks.length < 3) {
                textChunks = text.split(/\n+/)
                    .map(t => t.trim())
                    .filter(t => t.length > 30);
            }
            
            setStage('stageSegment', 'done');
            
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            // ===== EXCEL PROCESSING =====
            fileType = 'excel';
            updateProcessing('Parsing Excel file...', 'Reading sheets', 10);
            
            const workbook = XLSX.read(buffer, { type: 'array' });
            const allTexts = [];
            
            setStage('stageParse', 'done');
            setStage('stageOCR', 'done'); // Skip OCR
            setStage('stageSegment', 'active');
            updateProcessing('Processing sheets...', `${workbook.SheetNames.length} sheets found`, 30);
            
            workbook.SheetNames.forEach((sheetName, idx) => {
                updateProcessing(`Processing ${sheetName}`, `Sheet ${idx + 1}/${workbook.SheetNames.length}`, 30 + (idx / workbook.SheetNames.length) * 20);
                
                const sheet = workbook.Sheets[sheetName];
                const csv = XLSX.utils.sheet_to_csv(sheet);
                const rows = csv.split('\n').filter(r => r.trim().length > 0);
                
                // Group every 5-10 rows as a chunk for context
                for (let i = 0; i < rows.length; i += 5) {
                    const chunk = rows.slice(i, i + 5).join('\n');
                    if (chunk.trim().length > 20) {
                        allTexts.push(`[Sheet: ${sheetName}]\n${chunk}`);
                    }
                }
            });
            
            textChunks = allTexts;
            setStage('stageSegment', 'done');
            
        } else {
            throw new Error('Unsupported file type. Please use PDF, Word (.docx), or Excel (.xlsx)');
        }
        
        if (textChunks.length === 0) {
            throw new Error('No text extracted from document');
        }
        
        // Check for Hebrew content and warn user
        const allText = textChunks.join(' ');
        if (/[\u0590-\u05FF]/.test(allText)) {
            showToast('‚ö†Ô∏è Hebrew text detected. English-only analysis for now - results may be limited.', 'warning');
            console.log('Hebrew content detected in document');
        }
        
        // === STAGE 4: EMBEDDINGS ===
        setStage('stageEmbed', 'active');
        updateProcessing('Creating embeddings...', `0/${textChunks.length} vectors`, 55);
        
        const chunks = await generateEmbeddingsWithWorker(textChunks);
        
        setStage('stageEmbed', 'done');
        
        // === STAGE 5: ENCRYPT & SAVE ===
        setStage('stageEncrypt', 'active');
        updateProcessing('Encrypting...', 'Saving to vault', 95);
        
        const docData = {
            id: docId,
            name: file.name,
            fileType: fileType,
            chunkCount: chunks.length,
            usedOCR: needsOCR,
            createdAt: Date.now()
        };
        
        await saveDocument(docData);
        await saveVectors(docId, chunks);
        
        state.documents.push(docData);
        renderDocumentList();
        updateStats();
        updateMultiDocCount();
        
        setStage('stageEncrypt', 'done');
        updateProcessing('Done!', `${chunks.length} chunks processed`, 100);
        
        setTimeout(() => selectDocument(docId), 500);
        
    } catch (error) {
        console.error('Processing error:', error);
        showToast('Error: ' + error.message, 'error');
        showUploadArea();
    }
}

async function generateEmbeddingsWithWorker(texts) {
    return new Promise((resolve, reject) => {
        const chunks = [];
        let completed = 0;
        
        if (state.embeddingWorker && state.isEmbeddingReady) {
            // Use worker
            const handleMessage = (e) => {
                if (e.data.type === 'embedding') {
                    chunks[e.data.index] = {
                        text: texts[e.data.index],
                        embedding: e.data.embedding,
                        index: e.data.index
                    };
                    completed++;
                    
                    const pct = 55 + (completed / texts.length) * 40;
                    updateProcessing(`Embedding ${completed}/${texts.length}`, 'Generating vectors', pct);
                    
                    if (completed === texts.length) {
                        state.embeddingWorker.removeEventListener('message', handleMessage);
                        resolve(chunks.filter(Boolean));
                    }
                }
                if (e.data.type === 'error') {
                    reject(new Error(e.data.error));
                }
            };
            
            state.embeddingWorker.addEventListener('message', handleMessage);
            
            texts.forEach((text, idx) => {
                state.embeddingWorker.postMessage({
                    type: 'embed',
                    text: text.substring(0, 1000),
                    index: idx,
                    total: texts.length
                });
            });
            
        } else if (state.embeddingPipeline) {
            // Fallback to main thread
            (async () => {
                for (let i = 0; i < texts.length; i++) {
                    const output = await state.embeddingPipeline(texts[i].substring(0, 1000), { pooling: 'mean', normalize: true });
                    chunks.push({
                        text: texts[i],
                        embedding: Array.from(output.data),
                        index: i
                    });
                    
                    const pct = 55 + ((i + 1) / texts.length) * 40;
                    updateProcessing(`Embedding ${i + 1}/${texts.length}`, 'Generating vectors', pct);
                }
                resolve(chunks);
            })();
        } else {
            reject(new Error('No embedding model available'));
        }
    });
}

function segmentDocument(items) {
    items.sort((a, b) => Math.abs(a.y - b.y) > 3 ? b.y - a.y : a.x - b.x);
    
    const heights = items.map(i => i.height).filter(h => h > 0).sort((a, b) => a - b);
    const median = heights[Math.floor(heights.length / 2)] || 12;
    const threshold = median * 1.5;
    
    const chunks = [];
    let current = [];
    let lastY = items[0]?.y || 0;
    
    items.forEach((item, idx) => {
        if (idx === 0) { current.push(item.str); return; }
        const gap = lastY - item.y;
        if (gap > threshold) {
            const text = current.join(' ').trim();
            if (text.length > 30) chunks.push(text);
            current = [item.str];
        } else {
            current.push(item.str);
        }
        if (gap > 3) lastY = item.y;
    });
    
    const last = current.join(' ').trim();
    if (last.length > 30) chunks.push(last);
    
    return chunks;
}

// ==========================================
// PERSISTENCE
// ==========================================
async function loadDocuments() {
    const encrypted = await DB.getAll('documents');
    state.documents = [];
    for (const doc of encrypted) {
        try {
            const decrypted = await Crypto.decrypt(new Uint8Array(doc.data), state.encryptionKey);
            state.documents.push({ id: doc.id, ...decrypted });
        } catch (e) {
            console.error('Failed to decrypt document:', doc.id, e);
            // Skip corrupted documents
        }
    }
    renderDocumentList();
}

async function saveDocument(data) {
    // In demo mode, just store in memory
    if (state.isDemoMode) {
        return;
    }
    const encrypted = await Crypto.encrypt(data, state.encryptionKey);
    await DB.put('documents', { id: data.id, data: Array.from(encrypted) });
}

async function saveVectors(docId, chunks) {
    // In demo mode, store in memory
    if (state.isDemoMode) {
        if (!state.demoVectors) state.demoVectors = {};
        state.demoVectors[docId] = chunks;
        return;
    }
    await DB.deleteByIndex('vectors', 'docId', docId);
    for (const chunk of chunks) {
        const encrypted = await Crypto.encrypt(chunk, state.encryptionKey);
        await DB.put('vectors', { docId, data: Array.from(encrypted) });
    }
}

async function loadVectors(docId) {
    // In demo mode, load from memory
    if (state.isDemoMode && state.demoVectors && state.demoVectors[docId]) {
        return state.demoVectors[docId];
    }
    const encrypted = await DB.getByIndex('vectors', 'docId', docId);
    const vectors = [];
    for (const vec of encrypted) {
        try {
            const decrypted = await Crypto.decrypt(new Uint8Array(vec.data), state.encryptionKey);
            vectors.push(decrypted);
        } catch (e) {
            console.error('Failed to decrypt vector:', e);
        }
    }
    return vectors;
}

async function saveConversation(docId, messages) {
    // Skip in demo mode
    if (state.isDemoMode) return;
    const encrypted = await Crypto.encrypt({ messages }, state.encryptionKey);
    await DB.put('conversations', { docId, data: Array.from(encrypted) });
}

async function loadConversation(docId) {
    // Skip in demo mode
    if (state.isDemoMode) return [];
    try {
        const encrypted = await DB.get('conversations', docId);
        if (!encrypted) return [];
        const decrypted = await Crypto.decrypt(new Uint8Array(encrypted.data), state.encryptionKey);
        return decrypted.messages || [];
    } catch (e) {
        console.error('Failed to load conversation:', e);
        return [];
    }
}

async function deleteDocument(docId) {
    if (!confirm('Delete document?')) return;
    await DB.delete('documents', docId);
    await DB.deleteByIndex('vectors', 'docId', docId);
    await DB.delete('conversations', docId);
    state.documents = state.documents.filter(d => d.id !== docId);
    if (state.currentDocId === docId) showUploadArea();
    renderDocumentList();
    updateStats();
}

// ==========================================
// DOCUMENT SELECTION
// ==========================================
async function selectDocument(docId) {
    const doc = state.documents.find(d => d.id === docId);
    if (!doc) return;
    
    // Log to Privacy Monitor
    logPrivacyEvent('Document Loaded (Local)');
    
    state.currentDocId = docId;
    document.getElementById('currentDocName').textContent = doc.name;
    // chunkBadge hidden - internal info
    
    if (doc.usedOCR) {
        document.getElementById('ocrBadge').classList.remove('hidden');
    } else {
        document.getElementById('ocrBadge').classList.add('hidden');
    }
    
    renderDocumentList();
    
    state.currentChunks = await loadVectors(docId);
    renderSectionsGrid();
    
    const messages = await loadConversation(docId);
    renderConversation(messages);
    
    enableChat();
    
    // Hide upload/processing, show content
    document.getElementById('uploadArea').classList.add('hidden');
    document.getElementById('processingArea').classList.add('hidden');
    document.getElementById('viewToggle').classList.remove('hidden');
    document.getElementById('suggestionsArea').classList.remove('hidden');
    
    // Set default view mode to Analysis
    setViewMode('analysis');
}

function showUploadArea() {
    state.currentDocId = null;
    state.currentChunks = [];
    state.selectedClauseIndex = null;
    document.getElementById('currentDocName').textContent = 'Select a document';
    document.getElementById('chunkBadge').classList.add('hidden');
    document.getElementById('ocrBadge').classList.add('hidden');
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('processingArea').classList.add('hidden');
    document.getElementById('sectionsView').classList.add('hidden');
    document.getElementById('analysisView').classList.add('hidden');
    document.getElementById('viewToggle').classList.add('hidden');
    document.getElementById('selectedClauseBar').classList.add('hidden');
    document.getElementById('suggestionsArea').classList.add('hidden');
    document.getElementById('chatInput').disabled = true;
    document.getElementById('sendBtn').disabled = true;
    renderDocumentList();
}

// ==========================================
// VIEW MODE TOGGLE
// ==========================================
function setViewMode(mode) {
    state.viewMode = mode;
    
    const btnAnalysis = document.getElementById('btnAnalysis');
    const btnSections = document.getElementById('btnSections');
    const sectionsView = document.getElementById('sectionsView');
    const analysisView = document.getElementById('analysisView');
    
    if (mode === 'analysis') {
        // Update buttons
        btnAnalysis.classList.add('bg-blue-600', 'text-white');
        btnAnalysis.classList.remove('text-slate-400');
        btnSections.classList.remove('bg-blue-600', 'text-white');
        btnSections.classList.add('text-slate-400');
        
        // Show analysis, hide sections
        analysisView.classList.remove('hidden');
        sectionsView.classList.add('hidden');
    } else {
        // Update buttons
        btnSections.classList.add('bg-blue-600', 'text-white');
        btnSections.classList.remove('text-slate-400');
        btnAnalysis.classList.remove('bg-blue-600', 'text-white');
        btnAnalysis.classList.add('text-slate-400');
        
        // Show sections, hide analysis
        sectionsView.classList.remove('hidden');
        analysisView.classList.add('hidden');
    }
}

function renderSectionsGrid() {
    const grid = document.getElementById('sectionsGrid');
    if (!grid) return;
    
    grid.innerHTML = state.currentChunks.map((chunk, i) => `
        <div class="section-card group p-4 bg-slate-800/50 border border-slate-700/50 rounded-xl cursor-pointer hover:border-blue-500/50 hover:bg-slate-800/80 transition ${state.selectedClauseIndex === i ? 'ring-2 ring-blue-500 border-blue-500' : ''}" 
             data-index="${i}" 
             onclick="selectClause(${i})">
            <div class="similarity-bar mb-2" style="width: 0%;"></div>
            <div class="flex items-start gap-3">
                <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-1 rounded font-medium flex-shrink-0">#${i+1}</span>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-slate-300 line-clamp-3">${escapeHtml(chunk.text)}</p>
                </div>
                <button class="opacity-0 group-hover:opacity-100 text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded transition" onclick="event.stopPropagation(); selectClause(${i}); analyzeClauseByIndex(${i})">
                    üîç Analyze
                </button>
            </div>
        </div>
    `).join('');
}

function selectClause(index) {
    state.selectedClauseIndex = index;
    
    // Update selection UI
    document.querySelectorAll('.section-card').forEach((card, i) => {
        if (i === index) {
            card.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
        } else {
            card.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
        }
    });
    
    // Show selected clause bar
    const bar = document.getElementById('selectedClauseBar');
    const title = document.getElementById('selectedClauseTitle');
    bar.classList.remove('hidden');
    
    // Get clause preview for title
    const chunk = state.currentChunks[index];
    const preview = chunk.text.substring(0, 50) + (chunk.text.length > 50 ? '...' : '');
    title.textContent = `Section ${index + 1}: ${preview}`;
}

function clearClauseSelection() {
    state.selectedClauseIndex = null;
    document.querySelectorAll('.section-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
    });
    document.getElementById('selectedClauseBar').classList.add('hidden');
}

function analyzeClauseByIndex(index) {
    selectClause(index);
    setViewMode('analysis');
    
    // Analyze the selected clause
    const chunk = state.currentChunks[index];
    if (!chunk) return;
    
    addMessage('user', `üîç Analyze section #${index + 1}`);
    
    if (!state.isLLMReady) {
        // Fallback analysis
        let analysis = `**Section #${index + 1} Analysis** (AI not available)\n\n`;
        analysis += `**Text:**\n"${chunk.text.substring(0, 300)}${chunk.text.length > 300 ? '...' : ''}"\n\n`;
        
        const risks = [];
        if (/indemnif|hold harmless/i.test(chunk.text)) risks.push('‚ö†Ô∏è Indemnification clause');
        if (/terminat/i.test(chunk.text)) risks.push('üìã Termination terms');
        if (/confidential/i.test(chunk.text)) risks.push('üîí Confidentiality clause');
        if (/non-compete|noncompete/i.test(chunk.text)) risks.push('üö´ Non-compete clause');
        if (/liability|liable/i.test(chunk.text)) risks.push('‚öñÔ∏è Liability terms');
        if (/\$[\d,]+|\d+%/i.test(chunk.text)) risks.push('üí∞ Financial terms detected');
        
        if (risks.length > 0) {
            analysis += `**Detected:**\n${risks.join('\n')}\n\n`;
        } else {
            analysis += `**Detected:** Standard clause\n\n`;
        }
        
        analysis += `üí° *For AI analysis, wait for AI Model to load*`;
        addMessage('bot', analysis);
        return;
    }
    
    // Full AI analysis
    state.isProcessing = true;
    
    const systemPrompt = `Analyze this contract clause:

"${chunk.text}"

Provide:
1. **Type:** What kind of clause
2. **Summary:** One sentence
3. **Risk Level:** HIGH/MEDIUM/LOW with explanation
4. **Key Points:** 2-3 bullets
5. **Recommendation:** What to watch for`;

    state.llmEngine.chat.completions.create({
        messages: [{ role: 'user', content: systemPrompt }],
        max_tokens: 500,
        temperature: 0.3
    }).then(response => {
        const analysis = response.choices[0]?.message?.content || 'Could not analyze.';
        addMessage('bot', `üîç **Section #${index + 1} Analysis**\n\n${analysis}`);
    }).catch(e => {
        console.error('Analysis error:', e);
        addMessage('bot', '‚ùå Error: ' + e.message);
    }).finally(() => {
        state.isProcessing = false;
    });
}

// ==========================================
// SEMANTIC SEARCH (Single & Multi-Doc)
// ==========================================
async function semanticSearch(query, topK = 5) {
    console.log('semanticSearch called:', { 
        query, 
        topK, 
        isEmbeddingReady: state.isEmbeddingReady, 
        chunksCount: state.currentChunks.length 
    });
    
    if (!state.isEmbeddingReady || state.currentChunks.length === 0) {
        console.warn('Search aborted: embedding not ready or no chunks');
        return [];
    }
    
    let queryVec;
    
    if (state.embeddingPipeline) {
        const output = await state.embeddingPipeline(query, { pooling: 'mean', normalize: true });
        queryVec = Array.from(output.data);
    } else {
        return state.currentChunks.slice(0, topK);
    }
    
    // HYBRID SEARCH: Combine semantic + keyword
    const queryTerms = query.toLowerCase().split(/\s+/).filter(t => t.length > 2);
    
    const searchResults = state.currentChunks
        .map(chunk => {
            const semanticScore = cosineSimilarity(queryVec, chunk.embedding);
            
            // Keyword score (BM25-like)
            const textLower = chunk.text.toLowerCase();
            let keywordScore = 0;
            queryTerms.forEach(term => {
                const regex = new RegExp(term, 'gi');
                const matches = (textLower.match(regex) || []).length;
                if (matches > 0) {
                    keywordScore += Math.log(1 + matches) * 0.1;
                }
            });
            
            // Combined score: 70% semantic + 30% keyword
            const hybridScore = (semanticScore * 0.7) + (keywordScore * 0.3);
            
            return { 
                ...chunk, 
                similarity: hybridScore,
                semanticScore,
                keywordScore
            };
        })
        .sort((a, b) => b.similarity - a.similarity)
        .slice(0, topK);
    
    console.log('Hybrid Search results:', searchResults.map(r => ({ 
        hybrid: r.similarity?.toFixed(3),
        semantic: r.semanticScore?.toFixed(3), 
        keyword: r.keywordScore?.toFixed(3),
        textPreview: r.text?.substring(0, 50) + '...'
    })));
    
    return searchResults;
}

async function multiDocSearch(query, topK = 10) {
    if (!state.isEmbeddingReady || state.documents.length === 0) return [];
    
    let queryVec;
    
    if (state.embeddingPipeline) {
        const output = await state.embeddingPipeline(query, { pooling: 'mean', normalize: true });
        queryVec = Array.from(output.data);
    } else {
        return [];
    }
    
    // Load all vectors from all documents
    const allResults = [];
    
    for (const doc of state.documents) {
        const vectors = await loadVectors(doc.id);
        vectors.forEach(chunk => {
            allResults.push({
                ...chunk,
                docId: doc.id,
                docName: doc.name,
                similarity: cosineSimilarity(queryVec, chunk.embedding)
            });
        });
    }
    
    return allResults
        .sort((a, b) => b.similarity - a.similarity)
        .slice(0, topK);
}

function cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
        dot += a[i] * b[i];
        normA += a[i] * a[i];
        normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
}

// ==========================================
// LLM
// ==========================================
async function initLLM(maxAttempts = 3, initialDelay = 1000) {
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
        try {
            console.log(`ü§ñ LLM initialization attempt ${attempt + 1}/${maxAttempts}`);
            
            if (!navigator.gpu) {
                console.error('‚ùå WebGPU not available');
                updateStatus('llmStatus', 'warn', 'No GPU');
                setTimeout(() => {
                    showToast('WebGPU not available. Use Quick Start mode or try Chrome/Edge.', 'info');
                }, 2000);
                return;
            }
            
            if (!window.webllm) {
                console.error('‚ùå WebLLM library not loaded');
                updateStatus('llmStatus', 'error', 'No WebLLM');
                return;
            }
            
            state.llmEngine = new window.webllm.MLCEngine();
            state.llmEngine.setInitProgressCallback(r => {
                const percent = Math.round(r.progress * 100);
                console.log(`üì• LLM Loading: ${percent}%`);
                updateStatus('llmStatus', 'loading', `${percent}%`);
                
                if (percent === 1 && !localStorage.getItem('modelDownloaded')) {
                    showToast('Downloading AI model (~1.5GB). This only happens once.', 'info');
                }
            });
            
            await state.llmEngine.reload('Phi-3.5-mini-instruct-q4f16_1-MLC');
            state.isLLMReady = true;
            console.log('‚úÖ LLM Ready!');
            updateStatus('llmStatus', 'ready', 'LLM ‚úì');
            localStorage.setItem('modelDownloaded', 'true');
            return; // Success
            
        } catch (e) {
            console.error(`‚ùå LLM attempt ${attempt + 1} failed:`, e);
            
            // Cleanup before retry
            if (state.llmEngine) {
                try { 
                    await state.llmEngine.unload(); 
                } catch (cleanupErr) {
                    console.warn('Cleanup error:', cleanupErr);
                }
                state.llmEngine = null;
            }
            
            if (attempt < maxAttempts - 1) {
                const delay = initialDelay * Math.pow(2, attempt);
                const delaySec = Math.round(delay / 1000);
                updateStatus('llmStatus', 'loading', `Retry in ${delaySec}s`);
                showToast(`Retrying LLM... (${attempt + 2}/${maxAttempts})`, 'info');
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                // Final attempt failed
                updateStatus('llmStatus', 'error', 'AI Error');
                
                let errorMsg = 'AI model failed to load after 3 attempts.';
                if (e.message?.includes('memory')) {
                    errorMsg = 'Not enough memory. Close other tabs and try again.';
                } else if (e.message?.includes('network') || e.message?.includes('fetch')) {
                    errorMsg = 'Network error. Check your connection.';
                } else if (e.message?.includes('GPU') || e.message?.includes('adapter')) {
                    errorMsg = 'GPU error. Try updating graphics drivers.';
                }
                
                setTimeout(() => {
                    showError('AI Loading Failed', errorMsg + ' Try Quick Start mode or click System Status to retry.', e.message);
                }, 1000);
            }
        }
    }
}

// Retry LLM loading
function retryLLM() {
    console.log('üîÑ Retrying LLM...');
    showToast('Retrying AI model load...', 'info');
    initLLM(3, 1000);
}

// ==========================================
// CHAT (with Multi-Doc support)
// ==========================================

// Rule-based risk analysis for Quick Start mode (no LLM required)
function performRuleBasedAnalysis(results) {
    const flags = [];
    const text = results.map(r => r.text).join(' ').toLowerCase();
    
    // Risk detection patterns
    if (/indemnif/.test(text) && !/mutual/.test(text)) {
        flags.push('‚ö†Ô∏è One-sided indemnification detected');
    }
    if (/unlimited liability/.test(text) || (!/liability cap/.test(text) && /liability/.test(text))) {
        flags.push('‚ö†Ô∏è Missing or unlimited liability cap');
    }
    if (/terminat[^.]*\b(7|14)\s*days?\b/i.test(text)) {
        flags.push('‚ö†Ô∏è Short termination notice period');
    }
    if (/72\s*business\s*days/.test(text)) {
        flags.push('‚ö†Ô∏è Unusual breach notification period (72 business days)');
    }
    if (/personal\s*data/.test(text) && !/gdpr/.test(text)) {
        flags.push('‚ö†Ô∏è Personal data mentioned without GDPR reference');
    }
    if (!/confidential/.test(text) && /sensitive|proprietary/.test(text)) {
        flags.push('‚ö†Ô∏è Sensitive info mentioned without confidentiality clause');
    }
    if (/auto[- ]?renew/i.test(text) && !/cancel|opt[- ]?out/i.test(text)) {
        flags.push('‚ö†Ô∏è Auto-renewal without clear cancellation option');
    }
    if (/exclusive|non[- ]?compete/i.test(text)) {
        flags.push('‚ö†Ô∏è Exclusivity or non-compete clause detected');
    }
    
    return flags.length > 0 ? flags : ['‚úì No obvious risks detected - try full AI analysis for deeper review'];
}

async function handleChat() {
    const input = document.getElementById('chatInput');
    const query = input.value.trim();
    const isMultiDoc = document.getElementById('multiDocToggle')?.checked;
    
    // Allow multi-doc search even without current doc selected
    if (!query || state.isProcessing) return;
    if (!isMultiDoc && !state.currentDocId) return;
    
    // Log to Privacy Monitor
    logPrivacyEvent('Chat Query (Local)');
    
    state.isProcessing = true;
    input.value = '';
    input.disabled = true;
    
    addMessage('user', query);
    
    try {
        let results;
        let context;
        
        if (isMultiDoc && state.documents.length > 1) {
            // MULTI-DOCUMENT SEARCH
            results = await multiDocSearch(query, 15);
            
            // Group results by document for context - lower threshold
            let relevant = results.filter(r => r.similarity > 0.15);
            if (relevant.length === 0 && results.length > 0) {
                relevant = results.slice(0, 5);
            }
            // Limit to top 5 most relevant to avoid token overflow
            relevant = relevant.slice(0, 5);
            const contextParts = relevant.map(r => `[From: ${r.docName}]\n${r.text}`);
            context = contextParts.join('\n\n---\n\n');
            
            // Show which documents were searched
            const docsFound = [...new Set(relevant.map(r => r.docName))];
            if (relevant.length > 0) {
                const sourceInfo = `üìö Searched ${state.documents.length} documents. Found matches in: ${docsFound.join(', ')}`;
                addMessage('bot', sourceInfo);
            }
            
        } else {
            // SINGLE DOCUMENT SEARCH
            results = await semanticSearch(query, 5);
            visualizeResults(results);
            
            // Use lower threshold OR top results if none pass
            let relevant = results.filter(r => r.similarity > 0.15);
            if (relevant.length === 0 && results.length > 0) {
                // Fallback: use top 3 results regardless of similarity
                relevant = results.slice(0, 3);
                console.log('Using top results (low similarity):', relevant.map(r => r.similarity));
            }
            context = relevant.map(r => r.text).join('\n\n---\n\n');
        }
        
        // CRITICAL: Truncate context to fit LLM context window (4096 tokens ‚âà 12000 chars)
        // Leave room for system prompt (~500 tokens) and response (~1000 tokens)
        const MAX_CONTEXT_CHARS = 8000;
        const MIN_CUT_RATIO = 0.7; // At least 70% of max
        
        if (context.length > MAX_CONTEXT_CHARS) {
            let cutPoint = context.lastIndexOf('.', MAX_CONTEXT_CHARS);
            
            // If last period is too early, cut at word boundary instead
            if (cutPoint < MAX_CONTEXT_CHARS * MIN_CUT_RATIO) {
                cutPoint = context.lastIndexOf(' ', MAX_CONTEXT_CHARS);
            }
            
            // Fallback to hard limit
            if (cutPoint <= 0) cutPoint = MAX_CONTEXT_CHARS;
            
            console.log(`Context truncated: ${context.length} ‚Üí ${cutPoint} chars (at boundary)`);
            context = context.substring(0, cutPoint).trim() + '\n\n[... truncated ...]';
        }
        
        // Check if we have any context at all
        if (!context || context.trim().length < 50) {
            addMessage('bot', '‚ö†Ô∏è Could not find relevant sections in the document for this question. Try rephrasing or verify the document loaded correctly.');
            state.isProcessing = false;
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            return;
        }
        
        const relevant = results.filter(r => r.similarity > 0.1);
        
        // Check for Quick Start (embedding-only) mode
        const isEmbeddingOnly = document.getElementById('embeddingOnlyMode')?.checked || false;
        
        if (isEmbeddingOnly) {
            // Quick Start mode: use rule-based analysis without LLM
            const riskFlags = performRuleBasedAnalysis(results);
            const summary = riskFlags.join('\n');
            const topResult = relevant.length > 0 ? `\n\nüìÑ **Most relevant section:**\n"${relevant[0].text.substring(0, 250)}..."` : '';
            
            addMessage('bot', `‚ö° **Quick Analysis** (${relevant.length} sections found)\n\n${summary}${topResult}\n\nüí° *Disable Quick Start mode in System Status for full AI analysis*`);
            
        } else if (!state.isLLMReady) {
            // Show clear message that AI is not ready
            addMessage('bot', '‚ö†Ô∏è **AI Model not loaded** - Cannot generate summary.\n\nShowing search results instead:\n\n' + 
                (relevant.length > 0 
                    ? `Found ${relevant.length} relevant sections:\n\n"${relevant[0].text.substring(0, 300)}..."`
                    : 'No relevant sections found.') +
                '\n\nüí° **To enable AI summaries:**\n‚Ä¢ Use Chrome or Edge (not Safari)\n‚Ä¢ Wait for "AI Model" to show ‚úì Ready in System Status\n‚Ä¢ Click the status bar to check progress');
        } else {
            const systemPrompt = isMultiDoc
                ? `You are RegSecure, a Senior Legal Risk Auditor designed to protect client interests.
Your analysis runs locally and must be precise, cynical, and risk-averse.

RULES:
1. FOCUS: Only analyze the provided DOCUMENT EXCERPTS. Do not use outside knowledge.
2. NO FLUFF: Do not compliment. Go straight to risks and answers.
3. FORMAT: Use bullet points. Highlight "‚ö†Ô∏è CRITICAL RISK" or "‚ö†Ô∏è MISSING CLAUSE" when found.
4. TONE: Professional, direct, protective of the client.
5. CITE: Always mention which document each finding comes from.
6. If information is not in the excerpts, say: "Not found in documents."

EVALUATE FOR:
- One-sided indemnification
- Unlimited or missing liability caps
- Unclear termination rights
- Short or unusual time periods
- Data privacy issues

DOCUMENT EXCERPTS:
${context}`
                : `You are RegSecure, a Senior Legal Risk Auditor designed to protect client interests.
Your analysis runs locally and must be precise, cynical, and risk-averse.

RULES:
1. FOCUS: Only analyze the provided EXCERPTS. Do not use outside knowledge.
2. NO FLUFF: Do not compliment. Go straight to risks and answers.
3. FORMAT: Use bullet points. Highlight "‚ö†Ô∏è CRITICAL RISK" or "‚ö†Ô∏è MISSING CLAUSE" when found.
4. TONE: Professional, direct, protective of the client.
5. QUOTE: Cite relevant clauses when possible.
6. If information is not in the excerpt, say: "Not found in document."

EVALUATE FOR:
- One-sided indemnification
- Unlimited or missing liability caps
- Unclear termination rights
- Short or unusual time periods
- Data privacy issues

EXCERPTS:
${context}`;
            
            console.log('üì§ Sending to LLM:', { 
                contextLength: context.length, 
                promptLength: systemPrompt.length,
                query 
            });
            
            // Log local AI inference
            logPrivacyEvent('AI Model Inference (Local)');
            
            const stream = await state.llmEngine.chat.completions.create({
                messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: query }],
                temperature: 0.2,
                max_tokens: 800,
                stream: true
            });
            
            const msgDiv = addMessage('bot', '', true);
            let response = '';
            
            for await (const chunk of stream) {
                response += chunk.choices[0]?.delta?.content || '';
                msgDiv.innerHTML = formatMarkdown(response);
                msgDiv.dataset.rawText = response; // Store raw for copy
                document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
            }
        }
        
        // Save conversation
        if (state.currentDocId) {
            const chatArea = document.getElementById('chatArea');
            const messages = Array.from(chatArea.querySelectorAll('.chat-msg')).map(el => ({
                role: el.dataset.role,
                content: el.querySelector('.msg-content')?.textContent || ''
            })).filter(m => m.content);
            await saveConversation(state.currentDocId, messages);
        }
        
    } catch (error) {
        console.error('Chat error:', error);
        addMessage('bot', 'Error: ' + error.message);
    } finally {
        state.isProcessing = false;
        input.disabled = false;
        input.focus();
    }
}

// ==========================================
// UI HELPERS
// ==========================================
function updateProcessing(text, subtext, percent) {
    document.getElementById('processingText').textContent = text;
    document.getElementById('processingSubtext').textContent = subtext;
    document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
    
    const ring = document.getElementById('progressRing');
    const circumference = 352;
    ring.style.strokeDashoffset = circumference - (percent / 100) * circumference;
}

function setStage(id, status) {
    const el = document.getElementById(id);
    el.classList.remove('active', 'done');
    if (status) el.classList.add(status);
}

function resetStages() {
    ['stageParse', 'stageOCR', 'stageSegment', 'stageEmbed', 'stageEncrypt'].forEach(id => setStage(id, null));
}

function updateStatus(id, status, text) {
    const el = document.getElementById(id);
    if (!el) {
        console.warn('Status element not found:', id);
        return;
    }
    const colors = {
        ready: { dot: 'bg-green-600', text: 'text-green-600', border: 'border-green-600/30' },
        loading: { dot: 'bg-yellow-500 animate-pulse', text: 'text-yellow-400', border: 'border-yellow-500/30' },
        warn: { dot: 'bg-yellow-500', text: 'text-yellow-400', border: 'border-yellow-500/30' },
        error: { dot: 'bg-red-500', text: 'text-red-400', border: 'border-red-500/30' }
    };
    const c = colors[status] || colors.loading;
    el.innerHTML = `<div class="w-1.5 h-1.5 rounded-full ${c.dot}"></div><span class="${c.text}">${text}</span>`;
    
    // Track status for unified indicator
    el.dataset.status = status;
    el.dataset.ready = status === 'ready' ? 'true' : 'false';
    
    // Update unified system status
    updateUnifiedSystemStatus();
}

function updateUnifiedSystemStatus() {
    const workerStatus = document.getElementById('workerStatus')?.dataset?.status;
    const ocrStatus = document.getElementById('ocrStatus')?.dataset?.status;
    const llmStatus = document.getElementById('llmStatus')?.dataset?.status;
    
    const statusDot = document.getElementById('systemStatusDot');
    const statusText = document.getElementById('systemStatusText');
    
    if (!statusDot || !statusText) return;
    
    // Get LLM progress text if loading
    const llmEl = document.getElementById('llmStatus');
    const llmProgressMatch = llmEl?.textContent?.match(/(\d+)%/);
    const llmProgress = llmProgressMatch ? llmProgressMatch[1] : null;
    
    // Update detail modal if open
    const detailWorker = document.getElementById('detailWorker');
    const detailOCR = document.getElementById('detailOCR');
    const detailLLM = document.getElementById('detailLLM');
    
    if (detailWorker) {
        const span = detailWorker.querySelector('span:last-child');
        span.textContent = workerStatus === 'ready' ? '‚úì Ready' : 'Loading...';
        span.className = workerStatus === 'ready' ? 'text-green-600 text-xs' : 'text-yellow-400 text-xs';
    }
    if (detailOCR) {
        const span = detailOCR.querySelector('span:last-child');
        span.textContent = ocrStatus === 'ready' ? '‚úì Ready' : 'Loading...';
        span.className = ocrStatus === 'ready' ? 'text-green-600 text-xs' : 'text-yellow-400 text-xs';
    }
    if (detailLLM) {
        const span = detailLLM.querySelector('span:last-child');
        if (llmStatus === 'ready') {
            span.textContent = '‚úì Ready';
            span.className = 'text-green-600 text-xs';
        } else if (llmProgress) {
            span.textContent = `Downloading ${llmProgress}%`;
            span.className = 'text-yellow-400 text-xs';
        } else if (llmStatus === 'error' || llmStatus === 'warn') {
            span.textContent = llmEl?.textContent || 'Error';
            span.className = 'text-red-400 text-xs';
        } else {
            span.textContent = 'Loading...';
            span.className = 'text-yellow-400 text-xs';
        }
    }
    
    // Update main unified indicator
    // Green when embedding (worker) is ready - that's enough for all features
    const allReady = workerStatus === 'ready';
    const anyError = workerStatus === 'error' || ocrStatus === 'error' || llmStatus === 'error';
    
    if (allReady) {
        statusDot.className = 'w-2 h-2 rounded-full bg-green-600';
        statusText.textContent = '100% Local';
        statusText.className = 'text-green-600';
    } else if (anyError) {
        statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
        statusText.textContent = 'Error';
        statusText.className = 'text-red-400';
    } else if (llmProgress) {
        statusDot.className = 'w-2 h-2 rounded-full bg-blue-500 animate-pulse';
        statusText.textContent = `AI ${llmProgress}%`;
        statusText.className = 'text-blue-400';
    } else {
        statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
        statusText.textContent = 'Initializing...';
        statusText.className = 'text-yellow-400';
    }
}

function renderDocumentList() {
    const list = document.getElementById('documentList');
    if (state.documents.length === 0) {
        list.innerHTML = `<div class="text-center py-6">
            <div class="w-12 h-12 bg-slate-800 rounded-xl flex items-center justify-center mx-auto mb-3">
                <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <p class="text-xs text-slate-500 mb-1">No documents yet</p>
            <p class="text-[10px] text-slate-600">Upload a contract or try a sample</p>
        </div>`;
        return;
    }
    
    const getIcon = (doc) => {
        if (doc.usedOCR) return 'üîç';
        if (doc.fileType === 'word') return 'üìù';
        if (doc.fileType === 'excel') return 'üìä';
        return 'üìÑ';
    };
    
    list.innerHTML = state.documents.map(doc => `
        <div class="sidebar-item group flex items-center gap-2 p-2 rounded-lg border border-transparent cursor-pointer ${state.currentDocId === doc.id ? 'active' : ''}"
             onclick="selectDocument('${doc.id}')">
            <div class="w-7 h-7 bg-slate-800 rounded-lg flex items-center justify-center text-xs flex-shrink-0">
                ${getIcon(doc)}
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-xs text-slate-300 truncate">${escapeHtml(doc.name)}</p>
                <p class="text-[10px] text-slate-600">${doc.chunkCount} chunks</p>
            </div>
            <button onclick="event.stopPropagation(); deleteDocument('${doc.id}')" 
                class="hidden group-hover:block text-slate-600 hover:text-red-400 p-1">√ó</button>
        </div>
    `).join('');
    
    updateMultiDocCount();
}

function updateMultiDocCount() {
    const countEl = document.getElementById('multiDocCount');
    const toggleEl = document.getElementById('multiDocToggle');
    
    if (state.documents.length > 1) {
        countEl.textContent = `${state.documents.length} docs`;
        countEl.classList.remove('hidden');
        toggleEl.disabled = false;
    } else {
        countEl.classList.add('hidden');
        toggleEl.checked = false;
        toggleEl.disabled = true;
    }
}

// Legacy function - redirects to new system
function renderChunks() {
    renderSectionsGrid();
}

// Analyze chunk by index (called from sections view)
function analyzeChunkByIndex(index) {
    analyzeClauseByIndex(index);
}

function visualizeResults(results) {
    document.querySelectorAll('.section-card').forEach(el => {
        el.classList.remove('relevant');
        const bar = el.querySelector('.similarity-bar');
        if (bar) bar.style.width = '0%';
    });
    
    results.forEach(r => {
        const el = document.querySelector(`.section-card[data-index="${r.index}"]`);
        if (el && r.similarity > 0.25) {
            el.classList.add('relevant');
            const bar = el.querySelector('.similarity-bar');
            if (bar) bar.style.width = `${r.similarity * 100}%`;
            if (r === results[0]) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
}

function renderConversation(messages) {
    const chatArea = document.getElementById('chatArea');
    chatArea.innerHTML = '';
    if (messages.length === 0) {
        addMessage('bot', 'Ask questions about this document.');
    } else {
        messages.forEach(m => addMessage(m.role, m.content));
    }
}

function addMessage(role, content, returnDiv = false) {
    const chatArea = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.className = `chat-msg flex gap-2 ${role === 'user' ? 'justify-end' : ''} fade-in`;
    div.dataset.role = role;
    
    const msgId = 'msg_' + Date.now();
    
    if (role === 'user') {
        div.innerHTML = `
            <div class="bg-blue-600/20 border border-blue-500/30 rounded-xl rounded-tr-sm px-3 py-2 max-w-[85%]">
                <p class="msg-content text-sm">${escapeHtml(content)}</p>
            </div>
            <div class="w-6 h-6 bg-slate-700 rounded-lg flex items-center justify-center text-xs flex-shrink-0">üë§</div>
        `;
    } else {
        div.innerHTML = `
            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-blue-400 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/></svg>
            </div>
            <div class="bg-slate-800/50 rounded-xl rounded-tl-sm px-3 py-2 max-w-[85%] border border-slate-700/50 group relative">
                <div class="msg-content text-sm leading-relaxed" id="${msgId}">${formatMarkdown(content)}</div>
                <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                    <button onclick="copyMessage('${msgId}')" class="p-1 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition" title="Copy">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }
    
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
    return returnDiv ? div.querySelector('.msg-content') : div;
}

function copyMessage(msgId) {
    const el = document.getElementById(msgId);
    if (el) {
        // Use raw text if stored, otherwise fallback to textContent
        const text = el.dataset.rawText || el.textContent;
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard', 'success');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
    }
}

function enableChat() {
    document.getElementById('chatInput').disabled = false;
    document.getElementById('chatInput').placeholder = 'Ask about this document...';
    document.getElementById('sendBtn').disabled = false;
}

function clearChat() {
    if (state.currentDocId) {
        saveConversation(state.currentDocId, []);
        renderConversation([]);
    }
}

function updateStats() {
    document.getElementById('docCountStat').textContent = state.documents.length;
    const total = state.documents.reduce((sum, d) => sum + (d.chunkCount || 0), 0);
    document.getElementById('vectorCountStat').textContent = total;
    const kb = Math.round(total * 1.6);
    document.getElementById('storageStat').textContent = kb > 1000 ? `${(kb/1000).toFixed(1)} MB` : `${kb} KB`;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMarkdown(text) {
    if (!text) return '';
    
    // Escape HTML first
    let html = escapeHtml(text);
    
    // Bold: **text** or __text__
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>');
    html = html.replace(/__(.+?)__/g, '<strong class="text-white font-semibold">$1</strong>');
    
    // Italic: *text* or _text_
    html = html.replace(/\*([^*]+?)\*/g, '<em class="text-slate-200">$1</em>');
    html = html.replace(/_([^_]+?)_/g, '<em class="text-slate-200">$1</em>');
    
    // Inline code: `code`
    html = html.replace(/`([^`]+?)`/g, '<code class="bg-slate-700 px-1 rounded text-xs text-green-600">$1</code>');
    
    // Bullet points: - item or * item
    html = html.replace(/^[\-\*]\s+(.+)$/gm, '<li class="ml-4 text-slate-300">$1</li>');
    
    // Numbered lists: 1. item
    html = html.replace(/^\d+\.\s+(.+)$/gm, '<li class="ml-4 text-slate-300 list-decimal">$1</li>');
    
    // Wrap consecutive <li> in <ul>
    html = html.replace(/(<li[^>]*>.*?<\/li>\n?)+/g, '<ul class="my-2 space-y-1">$&</ul>');
    
    // Headers: ## Header
    html = html.replace(/^###\s+(.+)$/gm, '<h4 class="text-sm font-semibold text-blue-300 mt-2 mb-1">$1</h4>');
    html = html.replace(/^##\s+(.+)$/gm, '<h3 class="text-sm font-bold text-blue-200 mt-3 mb-1">$1</h3>');
    html = html.replace(/^#\s+(.+)$/gm, '<h2 class="text-base font-bold text-white mt-3 mb-2">$1</h2>');
    
    // Line breaks
    html = html.replace(/\n/g, '<br>');
    
    return html;
}

function askQuestion(q) {
    document.getElementById('chatInput').value = q;
    handleChat();
}

// Proper document summarization - uses ALL chunks, not search
async function summarizeDocument() {
    if (!state.currentDocId) {
        addMessage('bot', '‚ö†Ô∏è Please select a document first.');
        return;
    }
    
    // Log to Privacy Monitor
    logPrivacyEvent('Summarization Started');
    
    const doc = state.documents.find(d => d.id === state.currentDocId);
    
    // Check both doc.chunks AND state.currentChunks (sample docs use state.currentChunks)
    const chunks = doc?.chunks || state.currentChunks || [];
    if (chunks.length === 0) {
        addMessage('bot', '‚ö†Ô∏è Document has no content to summarize.');
        return;
    }
    
    const docName = doc?.name || 'Document';
    
    addMessage('user', 'üìù Summarize this document');
    
    if (!state.isLLMReady) {
        // Fallback: Basic summary without AI
        const totalChars = chunks.reduce((sum, c) => sum + c.text.length, 0);
        const preview = chunks.slice(0, 3).map(c => c.text.substring(0, 150)).join('... ');
        
        addMessage('bot', `üìÑ **Document Overview** (AI not available)\n\n` +
            `**Name:** ${docName}\n` +
            `**Sections:** ${chunks.length}\n` +
            `**Length:** ~${Math.round(totalChars / 5)} words\n\n` +
            `**Preview:**\n"${preview}..."\n\n` +
            `üí° *For full AI summary, wait for AI Model to load (check System Status)*`);
        return;
    }
    
    state.isProcessing = true;
    
    try {
        // Get all document text (limited to fit context window)
        const allText = chunks.map(c => c.text).join('\n\n');
        const maxChars = 6000; // Leave room for prompt and response
        const context = allText.length > maxChars 
            ? allText.substring(0, maxChars) + '\n\n[... document continues ...]'
            : allText;
        
        const systemPrompt = `You are a legal document summarizer. Provide a clear, structured summary.

DOCUMENT TO SUMMARIZE:
${context}

INSTRUCTIONS:
1. Start with a one-sentence overview
2. List the KEY PARTIES involved
3. List the MAIN TERMS (3-5 bullet points)
4. Note any IMPORTANT DATES or AMOUNTS
5. Flag any UNUSUAL or RISKY clauses
6. Keep it concise but complete`;

        // Log local AI inference
        logPrivacyEvent('AI Summarization (Local)');

        const response = await state.llmEngine.chat.completions.create({
            messages: [{ role: 'user', content: systemPrompt }],
            max_tokens: 800,
            temperature: 0.3
        });
        
        const summary = response.choices[0]?.message?.content || 'Could not generate summary.';
        addMessage('bot', `üìù **Document Summary**\n\n${summary}`);
        
    } catch (e) {
        console.error('Summarize error:', e);
        addMessage('bot', '‚ùå Error generating summary: ' + e.message);
    } finally {
        state.isProcessing = false;
    }
}

// Analyze currently selected/highlighted chunk
async function analyzeCurrentChunk() {
    if (!state.currentChunks || state.currentChunks.length === 0) {
        addMessage('bot', '‚ö†Ô∏è No document loaded.');
        return;
    }
    
    // Find currently highlighted chunk
    const highlighted = document.querySelector('.section-card.ring-2');
    let chunkIndex = 0;
    if (highlighted) {
        chunkIndex = parseInt(highlighted.dataset.index) || 0;
    }
    
    const chunk = state.currentChunks[chunkIndex];
    if (!chunk) {
        addMessage('bot', '‚ö†Ô∏è Could not find section to analyze.');
        return;
    }
    
    const chunkText = chunk.text;
    addMessage('user', `üîç Analyze section #${chunkIndex + 1}`);
    
    if (!state.isLLMReady) {
        // Fallback: Basic pattern analysis
        let analysis = `**Section #${chunkIndex + 1} Analysis** (AI not available)\n\n`;
        analysis += `**Text Preview:**\n"${chunkText.substring(0, 200)}..."\n\n`;
        
        // Check for risk patterns
        const risks = [];
        if (/indemnif|hold harmless/i.test(chunkText)) risks.push('‚ö†Ô∏è Indemnification clause');
        if (/terminat/i.test(chunkText)) risks.push('üìã Termination terms');
        if (/confidential/i.test(chunkText)) risks.push('üîí Confidentiality clause');
        if (/non-compete|noncompete/i.test(chunkText)) risks.push('üö´ Non-compete clause');
        if (/liability|liable/i.test(chunkText)) risks.push('‚öñÔ∏è Liability terms');
        if (/\$[\d,]+|\d+%/i.test(chunkText)) risks.push('üí∞ Financial terms detected');
        
        if (risks.length > 0) {
            analysis += `**Detected:**\n${risks.join('\n')}\n\n`;
        } else {
            analysis += `**Detected:** Standard clause, no special terms found.\n\n`;
        }
        
        analysis += `üí° *For detailed AI analysis, wait for AI Model to load*`;
        addMessage('bot', analysis);
        return;
    }
    
    state.isProcessing = true;
    
    try {
        const systemPrompt = `You are a legal clause analyzer. Analyze this specific contract section:

CLAUSE TEXT:
"${chunkText}"

PROVIDE:
1. **Type:** What kind of clause is this? (e.g., Termination, Payment, Liability, etc.)
2. **Summary:** One sentence explaining what it means
3. **Risk Level:** HIGH / MEDIUM / LOW with brief explanation
4. **Key Points:** 2-3 bullet points of important details
5. **Recommendation:** What the signing party should know or negotiate

Be direct and concise.`;

        const response = await state.llmEngine.chat.completions.create({
            messages: [{ role: 'user', content: systemPrompt }],
            max_tokens: 500,
            temperature: 0.3
        });
        
        const analysis = response.choices[0]?.message?.content || 'Could not analyze section.';
        addMessage('bot', `üîç **Section #${chunkIndex + 1} Analysis**\n\n${analysis}`);
        
    } catch (e) {
        console.error('Chunk analysis error:', e);
        addMessage('bot', '‚ùå Error analyzing section: ' + e.message);
    } finally {
        state.isProcessing = false;
    }
}

// ==========================================
// EVENT LISTENERS
// ==========================================
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

const SUPPORTED_TYPES = [
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
    'application/msword', // .doc
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
    'application/vnd.ms-excel' // .xls
];

const SUPPORTED_EXTENSIONS = ['.pdf', '.docx', '.doc', '.xlsx', '.xls'];

function isFileSupported(file) {
    const name = file.name.toLowerCase();
    return SUPPORTED_TYPES.includes(file.type) || SUPPORTED_EXTENSIONS.some(ext => name.endsWith(ext));
}

dropZone.onclick = () => fileInput.click();
dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); };
dropZone.ondragleave = () => dropZone.classList.remove('border-blue-500');
dropZone.ondrop = (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500');
    const file = e.dataTransfer.files[0];
    if (file && isFileSupported(file)) {
        processDocument(file);
    } else if (file) {
        showToast('Unsupported file type. Please use PDF, Word (.docx), or Excel (.xlsx)', 'error');
    }
};
fileInput.onchange = (e) => { if (e.target.files[0]) processDocument(e.target.files[0]); };

document.getElementById('chatInput').onkeypress = (e) => { if (e.key === 'Enter') handleChat(); };
document.getElementById('masterPassword').onkeypress = (e) => { if (e.key === 'Enter') unlockVault(); };

// Check for existing vault
DB.init().then(() => DB.get('meta', 'salt')).then(salt => {
    if (salt) {
        document.getElementById('unlockTitle').textContent = 'Welcome Back';
        document.getElementById('passwordHint').textContent = 'Vault found. Enter password.';
    }
}).catch(() => {});

// ==========================================
// BACKUP & RESTORE
// ==========================================
async function exportVault() {
    if (!state.encryptionKey) {
        showToast('Please unlock vault first', 'error');
        return;
    }
    
    if (!confirm('Download encrypted backup of all documents and chats?')) return;
    
    try {
        const backup = {
            version: 1,
            timestamp: Date.now(),
            salt: Array.from(state.salt),
            documents: await DB.getAll('documents'),
            vectors: await DB.getAll('vectors'),
            conversations: await DB.getAll('conversations')
        };
        
        const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `regsecure-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`Backup complete! ${state.documents.length} documents saved.`, 'success');
        
    } catch (e) {
        showToast('Export failed: ' + e.message, 'error');
    }
}

async function importVault(file) {
    if (!file) return;
    
    if (!confirm('‚ö†Ô∏è WARNING: This will OVERWRITE your current vault data. Continue?')) {
        document.getElementById('importInput').value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (!backup.version || !backup.salt || !backup.documents) {
                throw new Error('Invalid backup format');
            }
            
            // Clear and restore
            const tx = DB.db.transaction(['documents', 'vectors', 'conversations', 'meta'], 'readwrite');
            
            tx.objectStore('documents').clear();
            tx.objectStore('vectors').clear();
            tx.objectStore('conversations').clear();
            tx.objectStore('meta').put({ key: 'salt', value: backup.salt });
            
            backup.documents.forEach(d => tx.objectStore('documents').put(d));
            backup.vectors.forEach(v => tx.objectStore('vectors').put(v));
            backup.conversations.forEach(c => tx.objectStore('conversations').put(c));
            
            tx.oncomplete = () => {
                showToast(`Vault restored! ${backup.documents.length} documents recovered. Please reload.`, 'success');
                location.reload();
            };
            
            tx.onerror = () => {
                throw new Error('Database error during restore');
            };
            
        } catch (err) {
            showToast('Invalid backup file: ' + err.message, 'error');
            console.error(err);
        }
        
        document.getElementById('importInput').value = '';
    };
    reader.readAsText(file);
}

console.log('üöÄ RegSecure AI Ultimate - Workers + OCR + Backup + Word/Excel + Multi-Doc RAG');

// ==========================================
// FEATURE 1: PASSWORD STRENGTH METER
// ==========================================
function updatePasswordStrength() {
    const password = document.getElementById('masterPassword').value;
    const strengthDiv = document.getElementById('passwordStrength');
    const bars = [
        document.getElementById('strengthBar1'),
        document.getElementById('strengthBar2'),
        document.getElementById('strengthBar3'),
        document.getElementById('strengthBar4')
    ];
    const strengthText = document.getElementById('strengthText');
    
    if (password.length === 0) {
        strengthDiv.classList.add('hidden');
        return;
    }
    
    strengthDiv.classList.remove('hidden');
    
    let score = 0;
    if (password.length >= 8) score++;
    if (password.length >= 12) score++;
    if (/[A-Z]/.test(password) && /[a-z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;
    
    score = Math.min(4, score);
    
    const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-600'];
    const labels = ['Weak', 'Fair', 'Good', 'Strong'];
    
    bars.forEach((bar, i) => {
        bar.className = 'h-1 flex-1 rounded ' + (i < score ? colors[score - 1] : 'bg-slate-700');
    });
    
    strengthText.textContent = score > 0 ? labels[score - 1] : 'Too short';
    strengthText.className = 'text-[10px] ' + (score >= 3 ? 'text-green-600' : score >= 2 ? 'text-yellow-400' : 'text-red-400');
}

// ==========================================
// FEATURE 2: DEMO MODE
// ==========================================
const DEMO_DOCUMENTS = [
    {
        id: 'demo_nda',
        name: 'Sample NDA Agreement.pdf',
        fileType: 'pdf',
        content: `NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement ("Agreement") is entered into as of January 15, 2024 by and between:

ACME Corporation, a Delaware corporation with offices at 123 Innovation Drive, San Francisco, CA 94105 ("Disclosing Party")

AND

TechStart Inc., a California corporation with offices at 456 Startup Lane, Palo Alto, CA 94301 ("Receiving Party")

1. CONFIDENTIAL INFORMATION
"Confidential Information" means any non-public information disclosed by Disclosing Party, including but not limited to: trade secrets, business plans, customer lists, financial data, technical specifications, and proprietary algorithms.

2. OBLIGATIONS
The Receiving Party agrees to:
a) Hold all Confidential Information in strict confidence
b) Not disclose any Confidential Information to third parties without prior written consent
c) Use Confidential Information solely for the Purpose defined herein
d) Return or destroy all Confidential Information upon request

3. TERM
This Agreement shall remain in effect for a period of three (3) years from the Effective Date. The confidentiality obligations shall survive termination for an additional five (5) years.

4. EXCLUSIONS
This Agreement does not apply to information that:
a) Was publicly known at the time of disclosure
b) Becomes publicly known through no fault of Receiving Party
c) Was rightfully in Receiving Party's possession prior to disclosure

5. REMEDIES
The parties acknowledge that breach of this Agreement may cause irreparable harm. The Disclosing Party shall be entitled to seek injunctive relief in addition to any other remedies available at law.

6. GOVERNING LAW
This Agreement shall be governed by the laws of the State of California.

7. LIMITATION OF LIABILITY
In no event shall either party be liable for indirect, incidental, or consequential damages exceeding $500,000.

IN WITNESS WHEREOF, the parties have executed this Agreement.

ACME Corporation                    TechStart Inc.
By: John Smith, CEO                 By: Jane Doe, CEO
Date: January 15, 2024             Date: January 15, 2024`
    },
    {
        id: 'demo_lease',
        name: 'Office Lease Agreement.docx',
        fileType: 'word',
        content: `COMMERCIAL LEASE AGREEMENT

PARTIES:
Landlord: Metropolitan Properties LLC ("Landlord")
Address: 789 Real Estate Blvd, New York, NY 10001

Tenant: Digital Solutions Corp ("Tenant")
Address: 321 Tech Avenue, New York, NY 10002

PROPERTY:
Suite 500, Tower One, 100 Business Park Way, New York, NY 10003
Approximately 5,000 square feet of office space

TERM:
Commencement Date: March 1, 2024
Expiration Date: February 28, 2029
Initial Term: Five (5) years

RENT:
Base Rent: $45.00 per square foot per annum
Monthly Payment: $18,750.00
Annual Rent: $225,000.00

Payment Due: First day of each calendar month
Late Fee: 5% if paid after the 10th day

SECURITY DEPOSIT: $56,250.00 (Three months' rent)

RENT ESCALATION:
Annual increase of 3% beginning on the first anniversary of the Commencement Date.

PERMITTED USE:
General office use, software development, and related business activities.

MAINTENANCE:
Landlord responsible for: structural repairs, HVAC systems, common areas
Tenant responsible for: interior maintenance, janitorial services

INSURANCE REQUIREMENTS:
- General Liability: $2,000,000 per occurrence
- Property Insurance: Full replacement value
- Workers Compensation: As required by law

TERMINATION:
Either party may terminate with 180 days written notice after the initial 24-month period, subject to early termination fee equal to 3 months' rent.

DEFAULT:
Failure to pay rent within 30 days constitutes default. Landlord may pursue eviction and damages.

GOVERNING LAW: State of New York

SIGNATURES:
Metropolitan Properties LLC          Digital Solutions Corp
By: Robert Johnson, Manager          By: Sarah Williams, CFO
Date: February 1, 2024              Date: February 1, 2024`
    },
    {
        id: 'demo_employment',
        name: 'Employment Contract.xlsx',
        fileType: 'excel',
        content: `EMPLOYMENT AGREEMENT

EMPLOYER: InnovateTech Systems Inc.
EMPLOYEE: Michael Chen
POSITION: Senior Software Engineer
DEPARTMENT: Engineering
REPORTS TO: VP of Engineering

EMPLOYMENT DETAILS:
Start Date: April 1, 2024
Employment Type: Full-time, Exempt
Work Location: Hybrid (3 days office, 2 days remote)
Office Address: 555 Silicon Valley Blvd, Mountain View, CA 94043

COMPENSATION:
Base Salary: $185,000.00 per annum
Pay Frequency: Bi-weekly
Signing Bonus: $25,000.00 (subject to 1-year clawback)

EQUITY:
Stock Options: 50,000 shares
Vesting Schedule: 4-year vesting with 1-year cliff
Strike Price: $2.50 per share

BENEFITS:
Health Insurance: 100% employee, 75% dependents
Dental & Vision: 100% covered
401(k): 4% company match
PTO: 20 days per year
Sick Leave: 10 days per year
Parental Leave: 16 weeks paid

PERFORMANCE BONUS:
Target: 15% of base salary
Maximum: 25% of base salary
Based on individual and company performance metrics

TERMINATION:
At-will employment
Notice Period: 2 weeks (4 weeks for company-initiated)
Severance: 2 weeks per year of service (company-initiated without cause)

NON-COMPETE:
Duration: 12 months post-employment
Geographic Scope: United States
Industry: Enterprise software development

INTELLECTUAL PROPERTY:
All work product created during employment belongs to Employer.

CONFIDENTIALITY:
Employee agrees to maintain confidentiality of proprietary information indefinitely.

GOVERNING LAW: State of California

ACCEPTED AND AGREED:

InnovateTech Systems Inc.           Employee
By: Lisa Park, HR Director          Michael Chen
Date: March 15, 2024               Date: March 15, 2024`
    }
];

async function loadDemoMode() {
    state.isDemoMode = true;
    
    // Hide unlock modal
    document.getElementById('unlockModal').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    // Update UI to show demo mode
    const header = document.querySelector('header');
    if (header) header.classList.add('border-amber-500/30');
    const demoIndicator = document.createElement('div');
    demoIndicator.id = 'demoIndicator';
    demoIndicator.className = 'bg-blue-600 text-white text-[10px] px-2.5 py-1 rounded-full ml-2 font-medium shadow-sm';
    demoIndicator.textContent = '‚ö° Quick Start';
    const headerFlex = document.querySelector('header .flex');
    if (headerFlex) headerFlex.appendChild(demoIndicator);
    
    // Initialize embedding model
    updateStatus('workerStatus', 'loading', 'Loading...');
    
    // Wait for transformers to be ready
    if (!window.TransformersJS) {
        await new Promise(resolve => {
            window.addEventListener('transformers-ready', resolve, { once: true });
        });
    }
    
    try {
        state.embeddingPipeline = await window.TransformersJS.pipeline(
            'feature-extraction', 
            'Xenova/all-MiniLM-L6-v2',
            { quantized: true }
        );
        state.isEmbeddingReady = true;
        updateStatus('workerStatus', 'ready', 'Embed ‚úì');
    } catch (e) {
        console.error('Embedding init error:', e);
        updateStatus('workerStatus', 'error', 'Error');
    }
    
    // Process demo documents
    for (const demoDoc of DEMO_DOCUMENTS) {
        await processDemoDocument(demoDoc);
    }
    
    // Initialize LLM in background
    initLLM();
    
    // Log demo start
    logAudit('system', 'Quick Start activated');
    
    // Select first document
    if (state.documents.length > 0) {
        selectDocument(state.documents[0].id);
    }
    
    addMessage('bot', '‚ö° Quick Start active! Try the sample contracts (NDA, SaaS, DPA) in the sidebar, or upload your own document.');
}

async function processDemoDocument(demoDoc) {
    const textChunks = demoDoc.content.split(/\n\n+/).filter(t => t.trim().length > 30);
    
    // Generate embeddings
    const chunks = [];
    for (let i = 0; i < textChunks.length; i++) {
        const output = await state.embeddingPipeline(textChunks[i], { pooling: 'mean', normalize: true });
        chunks.push({
            text: textChunks[i],
            embedding: Array.from(output.data),
            index: i
        });
    }
    
    const docData = {
        id: demoDoc.id,
        name: demoDoc.name,
        fileType: demoDoc.fileType,
        chunkCount: chunks.length,
        usedOCR: false,
        createdAt: Date.now(),
        isDemo: true
    };
    
    state.documents.push(docData);
    
    // Store chunks in memory for demo (not IndexedDB)
    if (!state.demoVectors) state.demoVectors = {};
    state.demoVectors[demoDoc.id] = chunks;
    
    renderDocumentList();
    updateStats();
}

// ==========================================
// FEATURE 3: ENTITY EXTRACTION
// ==========================================
async function extractEntities() {
    if (!state.currentChunks || state.currentChunks.length === 0) {
        showToast('Please select a document first', 'error');
        return;
    }
    
    const text = state.currentChunks.map(c => c.text).join('\n');
    
    // Extract patterns
    const entities = {
        dates: [],
        amounts: [],
        parties: [],
        durations: [],
        emails: [],
        addresses: []
    };
    
    // Date patterns
    const datePatterns = [
        /\b(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}\b/gi,
        /\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/g,
        /\b\d{4}-\d{2}-\d{2}\b/g
    ];
    datePatterns.forEach(pattern => {
        const matches = text.match(pattern) || [];
        entities.dates.push(...matches);
    });
    
    // Money amounts
    const amountPattern = /\$[\d,]+(?:\.\d{2})?(?:\s*(?:per|\/)\s*(?:month|year|annum|hour|day|week|square foot))?|\b\d+(?:,\d{3})*(?:\.\d{2})?\s*(?:dollars|USD)\b/gi;
    entities.amounts = [...new Set(text.match(amountPattern) || [])];
    
    // Duration patterns
    const durationPattern = /\b\d+\s*(?:day|week|month|year)s?\b|\b(?:one|two|three|four|five|six|seven|eight|nine|ten)\s*\(?(?:\d+)?\)?\s*(?:day|week|month|year)s?\b/gi;
    entities.durations = [...new Set(text.match(durationPattern) || [])];
    
    // Email addresses
    const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
    entities.emails = [...new Set(text.match(emailPattern) || [])];
    
    // Party names (look for patterns like "Company Name, a [State] corporation")
    const partyPattern = /([A-Z][A-Za-z\s]+(?:Inc|LLC|Corp|Corporation|Company|Ltd|LLP|LP)?\.?),?\s*(?:a\s+)?(?:[A-Z][a-z]+\s+)?(?:corporation|company|LLC|partnership)/g;
    let partyMatch;
    while ((partyMatch = partyPattern.exec(text)) !== null) {
        entities.parties.push(partyMatch[1].trim());
    }
    entities.parties = [...new Set(entities.parties)];
    
    // Build response
    let response = 'üìã **Extracted Entities:**\n\n';
    
    if (entities.parties.length > 0) {
        response += `üë• **Parties:** ${entities.parties.join(', ')}\n\n`;
    }
    if (entities.dates.length > 0) {
        response += `üìÖ **Dates:** ${[...new Set(entities.dates)].slice(0, 10).join(', ')}\n\n`;
    }
    if (entities.amounts.length > 0) {
        response += `üí∞ **Amounts:** ${entities.amounts.slice(0, 10).join(', ')}\n\n`;
    }
    if (entities.durations.length > 0) {
        response += `‚è±Ô∏è **Durations:** ${[...new Set(entities.durations)].slice(0, 10).join(', ')}\n\n`;
    }
    if (entities.emails.length > 0) {
        response += `üìß **Emails:** ${entities.emails.join(', ')}\n\n`;
    }
    
    if (Object.values(entities).every(arr => arr.length === 0)) {
        response = 'No entities found in this document.';
    }
    
    addMessage('bot', response);
    logAudit('entity_extraction', `Extracted entities from ${state.documents.find(d => d.id === state.currentDocId)?.name}`);
}

// ==========================================
// FEATURE 4: EXPORT SUMMARY
// ==========================================
function exportSummary() {
    const chatArea = document.getElementById('chatArea');
    const messages = Array.from(chatArea.querySelectorAll('.chat-msg'));
    
    if (messages.length === 0) {
        showToast('No conversation to export', 'error');
        return;
    }
    
    const doc = state.documents.find(d => d.id === state.currentDocId);
    const docName = doc?.name || 'Unknown Document';
    
    let content = `RegSecure AI - Conversation Export\n`;
    content += `${'='.repeat(50)}\n\n`;
    content += `Document: ${docName}\n`;
    content += `Exported: ${new Date().toLocaleString()}\n`;
    content += `${'='.repeat(50)}\n\n`;
    
    messages.forEach(msg => {
        const role = msg.dataset.role === 'user' ? 'USER' : 'AI';
        const text = msg.querySelector('.msg-content')?.textContent || '';
        content += `[${role}]\n${text}\n\n`;
    });
    
    content += `${'='.repeat(50)}\n`;
    content += `Generated by RegSecure AI\n`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `regsecure-chat-${docName.replace(/[^a-z0-9]/gi, '_')}-${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    logAudit('export', `Exported conversation for ${docName}`);
}

// ==========================================
// FEATURE 4B: EXPORT PDF REPORT
// ==========================================
async function exportPDFReport() {
    const { jsPDF } = window.jspdf;
    
    if (!state.currentDocId && !state.isDemoMode) {
        showToast('Please select a document first', 'error');
        return;
    }
    
    showToast('Generating PDF report...', 'info');
    
    const doc = state.documents.find(d => d.id === state.currentDocId);
    const docName = doc?.name || 'Demo Document';
    const chunks = state.currentChunks || [];
    
    // Run risk analysis first
    const risks = { high: [], medium: [], low: [], missing: [] };
    const fullText = chunks.map(c => c.text).join(' ');
    
    chunks.forEach((chunk, index) => {
        const text = chunk.text;
        for (const [level, config] of Object.entries(RISK_PATTERNS)) {
            if (level === 'missing' || !config.patterns) continue;
            for (const pattern of config.patterns) {
                const matches = text.match(pattern);
                if (matches) {
                    risks[level].push({
                        text: text.substring(0, 200) + '...',
                        matches: [...new Set(matches)].slice(0, 3)
                    });
                    break;
                }
            }
        }
    });
    
    // Check missing clauses
    if (RISK_PATTERNS.missing?.checkMissing) {
        RISK_PATTERNS.missing.checkMissing.forEach(check => {
            if (!check.pattern.test(fullText)) {
                risks.missing.push({ name: check.name });
            }
        });
    }
    
    // Create PDF
    const pdf = new jsPDF();
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 20;
    let y = 20;
    
    // Header
    pdf.setFillColor(79, 70, 229);
    pdf.rect(0, 0, pageWidth, 40, 'F');
    
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(22);
    pdf.setFont('helvetica', 'bold');
    pdf.text('RegSecure AI', margin, 18);
    
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'normal');
    pdf.text('Contract Risk Assessment Report', margin, 30);
    
    // Document Info
    y = 55;
    pdf.setTextColor(0, 0, 0);
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Document:', margin, y);
    pdf.setFont('helvetica', 'normal');
    pdf.text(docName, margin + 25, y);
    
    y += 7;
    pdf.setFont('helvetica', 'bold');
    pdf.text('Date:', margin, y);
    pdf.setFont('helvetica', 'normal');
    pdf.text(new Date().toLocaleDateString(), margin + 25, y);
    
    y += 7;
    pdf.setFont('helvetica', 'bold');
    pdf.text('Analysis:', margin, y);
    pdf.setFont('helvetica', 'normal');
    pdf.text('100% Local Processing - No data sent to external servers', margin + 25, y);
    
    // Calculate Risk Score for PDF (same formula as analyzeRisks)
    const rawScore = 10 - 
        (risks.high.length * 2.5) -
        (risks.missing.length * 1.5) -
        (risks.medium.length * 0.5);
    const riskScore = Math.max(0, Math.min(10, rawScore)).toFixed(1);
    
    let riskLevel, riskLevelColor;
    if (riskScore >= 7) {
        riskLevel = 'Good';
        riskLevelColor = [34, 197, 94]; // green
    } else if (riskScore >= 4) {
        riskLevel = 'Moderate';
        riskLevelColor = [245, 158, 11]; // yellow/orange
    } else {
        riskLevel = 'Critical';
        riskLevelColor = [239, 68, 68]; // red
    }
    
    // Summary Box with Risk Score
    y += 15;
    pdf.setFillColor(248, 250, 252);
    pdf.roundedRect(margin, y, pageWidth - margin * 2, 50, 3, 3, 'F');
    
    // Safety Score Badge
    y += 12;
    pdf.setFontSize(14);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...riskLevelColor);
    pdf.text(`SAFETY SCORE: ${riskScore} / 10`, margin + 5, y);
    
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'normal');
    pdf.text(`(${riskLevel})`, margin + 55, y);
    
    // Progress bar visual
    y += 8;
    const barWidth = 100;
    const barHeight = 6;
    const filledWidth = (parseFloat(riskScore) / 10) * barWidth;
    
    pdf.setFillColor(226, 232, 240); // gray background
    pdf.roundedRect(margin + 5, y, barWidth, barHeight, 2, 2, 'F');
    
    pdf.setFillColor(...riskLevelColor);
    if (filledWidth > 0) {
        pdf.roundedRect(margin + 5, y, filledWidth, barHeight, 2, 2, 'F');
    }
    
    // Risk counts
    y += 15;
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(0, 0, 0);
    pdf.text('Breakdown:', margin + 5, y);
    
    y += 7;
    pdf.setFont('helvetica', 'normal');
    
    // Risk counts with colors
    pdf.setTextColor(239, 68, 68);
    pdf.text(`High Risk: ${risks.high.length}`, margin + 5, y);
    
    pdf.setTextColor(245, 158, 11);
    pdf.text(`Medium Risk: ${risks.medium.length}`, margin + 50, y);
    
    pdf.setTextColor(234, 88, 12);
    pdf.text(`Missing Clauses: ${risks.missing.length}`, margin + 105, y);
    
    pdf.setTextColor(34, 197, 94);
    pdf.text(`Standard: ${risks.low.length}`, margin + 5, y + 7);
    
    // Missing Clauses Section
    if (risks.missing.length > 0) {
        y += 20;
        pdf.setTextColor(234, 88, 12);
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'bold');
        pdf.text('‚ö† Missing Clauses - Action Required', margin, y);
        
        y += 8;
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        
        risks.missing.forEach((m, i) => {
            pdf.text(`${i + 1}. ${m.name} not found in document`, margin + 5, y);
            y += 6;
        });
    }
    
    // High Risk Section
    if (risks.high.length > 0) {
        y += 15;
        pdf.setTextColor(239, 68, 68);
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'bold');
        pdf.text('High Risk Items - Immediate Review Required', margin, y);
        
        y += 8;
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(9);
        pdf.setFont('helvetica', 'normal');
        
        risks.high.slice(0, 5).forEach((r, i) => {
            if (y > 260) {
                pdf.addPage();
                y = 20;
            }
            pdf.setFont('helvetica', 'bold');
            pdf.text(`${i + 1}. Issue: ${r.matches.join(', ')}`, margin + 5, y);
            y += 5;
            pdf.setFont('helvetica', 'normal');
            const lines = pdf.splitTextToSize(`"${r.text}"`, pageWidth - margin * 2 - 10);
            pdf.text(lines, margin + 5, y);
            y += lines.length * 4 + 5;
        });
    }
    
    // Medium Risk Section
    if (risks.medium.length > 0) {
        y += 10;
        if (y > 240) {
            pdf.addPage();
            y = 20;
        }
        pdf.setTextColor(245, 158, 11);
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Medium Risk Items - Review Recommended', margin, y);
        
        y += 8;
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(9);
        pdf.setFont('helvetica', 'normal');
        
        risks.medium.slice(0, 5).forEach((r, i) => {
            if (y > 260) {
                pdf.addPage();
                y = 20;
            }
            pdf.setFont('helvetica', 'bold');
            pdf.text(`${i + 1}. Issue: ${r.matches.join(', ')}`, margin + 5, y);
            y += 5;
            pdf.setFont('helvetica', 'normal');
            const lines = pdf.splitTextToSize(`"${r.text}"`, pageWidth - margin * 2 - 10);
            pdf.text(lines, margin + 5, y);
            y += lines.length * 4 + 5;
        });
    }
    
    // Footer on last page
    const pageCount = pdf.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFontSize(8);
        pdf.setTextColor(156, 163, 175);
        pdf.text(
            `RegSecure AI - Patent Pending US 19/428,113 - 100% Local Processing - Page ${i} of ${pageCount}`,
            pageWidth / 2,
            pdf.internal.pageSize.getHeight() - 10,
            { align: 'center' }
        );
    }
    
    // Save
    const fileName = `RegSecure-Risk-Report-${docName.replace(/[^a-z0-9]/gi, '_')}-${new Date().toISOString().slice(0, 10)}.pdf`;
    pdf.save(fileName);
    
    showToast('PDF Report downloaded!', 'success');
    logAudit('export', `Exported PDF report for ${docName}`);
}

// ==========================================
// FEATURE 5: SESSION TIMEOUT
// ==========================================
function resetActivityTimer() {
    state.lastActivity = Date.now();
}

function checkSessionTimeout() {
    if (!state.encryptionKey && !state.isDemoMode) return;
    
    const elapsed = Date.now() - state.lastActivity;
    if (elapsed > state.sessionTimeout) {
        if (state.isDemoMode) {
            showToast('Session timed out after 15 minutes of inactivity.', 'info');
            location.reload();
        } else {
            showToast('Session timed out for security. Please unlock again.', 'info');
            lockVault();
        }
    }
}

// Start session timer
setInterval(checkSessionTimeout, 60000); // Check every minute

// Reset timer on activity
['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
    document.addEventListener(event, resetActivityTimer, { passive: true });
});

// ==========================================
// FEATURE 6: KEYBOARD SHORTCUTS
// ==========================================
document.addEventListener('keydown', (e) => {
    // Only when vault is unlocked
    if (document.getElementById('unlockModal').classList.contains('hidden') === false) return;
    
    // Ctrl/Cmd + K: Focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('chatInput').focus();
    }
    
    // Ctrl/Cmd + N: New document
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        showUploadArea();
    }
    
    // Ctrl/Cmd + L: Lock vault
    if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
        e.preventDefault();
        if (!state.isDemoMode) lockVault();
    }
    
    // Ctrl/Cmd + E: Export summary
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        if (state.currentDocId) exportSummary();
    }
    
    // Ctrl/Cmd + B: Backup
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        if (!state.isDemoMode) exportVault();
    }
    
    // Escape: Clear input
    if (e.key === 'Escape') {
        document.getElementById('chatInput').value = '';
        document.getElementById('chatInput').blur();
    }
    
    // Ctrl/Cmd + 1-9: Select document
    if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '9') {
        e.preventDefault();
        const idx = parseInt(e.key) - 1;
        if (state.documents[idx]) {
            selectDocument(state.documents[idx].id);
        }
    }
});

// Show keyboard shortcuts hint
console.log(`
‚å®Ô∏è Keyboard Shortcuts:
   Ctrl+K: Focus search
   Ctrl+N: New document
   Ctrl+L: Lock vault
   Ctrl+E: Export chat
   Ctrl+B: Backup vault
   Ctrl+1-9: Select document
   Escape: Clear input
`);

// ==========================================
// FEATURE 7: AUDIT LOG
// ==========================================
function logAudit(action, details) {
    state.auditLog.push({
        timestamp: new Date().toISOString(),
        action: action,
        details: details,
        docId: state.currentDocId,
        docName: state.documents.find(d => d.id === state.currentDocId)?.name || null
    });
}

function exportAuditLog() {
    if (state.auditLog.length === 0) {
        showToast('Audit log is empty', 'info');
        return;
    }
    
    let content = `RegSecure AI - Audit Log Export\n`;
    content += `${'='.repeat(60)}\n\n`;
    content += `Exported: ${new Date().toLocaleString()}\n`;
    content += `Total Entries: ${state.auditLog.length}\n`;
    content += `${'='.repeat(60)}\n\n`;
    
    state.auditLog.forEach((entry, i) => {
        content += `[${i + 1}] ${entry.timestamp}\n`;
        content += `    Action: ${entry.action}\n`;
        content += `    Details: ${entry.details}\n`;
        if (entry.docName) content += `    Document: ${entry.docName}\n`;
        content += `\n`;
    });
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `regsecure-audit-${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ==========================================
// FEATURE 8: ENHANCED AUDIT LOGGING
// ==========================================
// Wrap existing functions to add audit logging
const originalHandleChat = handleChat;
handleChat = async function() {
    const query = document.getElementById('chatInput').value.trim();
    if (query) {
        logAudit('query', query);
    }
    return originalHandleChat.apply(this, arguments);
};

const originalSelectDocument = selectDocument;
selectDocument = async function(docId) {
    const doc = state.documents.find(d => d.id === docId);
    if (doc) {
        logAudit('open_document', doc.name);
    }
    
    // Handle demo mode vectors
    if (state.isDemoMode && state.demoVectors && state.demoVectors[docId]) {
        state.currentDocId = docId;
        state.currentChunks = state.demoVectors[docId];
        document.getElementById('currentDocName').textContent = doc.name;
        // chunkBadge hidden - internal info
        
        renderDocumentList();
        renderSectionsGrid();
        renderConversation([]);
        
        document.getElementById('uploadArea').classList.add('hidden');
        document.getElementById('processingArea').classList.add('hidden');
        document.getElementById('viewToggle').classList.remove('hidden');
        document.getElementById('suggestionsArea').classList.remove('hidden');
        setViewMode('analysis');
        enableChat();
        return;
    }
    
    return originalSelectDocument.apply(this, arguments);
};

// ==========================================
// KEYBOARD SHORTCUTS
// ==========================================
window.onkeydown = (e) => {
    // Reset timer on any key
    resetActivityTimer();
    
    if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
            case 'k': // Search/Focus Chat
                e.preventDefault();
                const input = document.getElementById('chatInput');
                if (input) {
                    input.disabled = false;
                    input.focus();
                }
                break;
            case 'n': // New Document
                e.preventDefault();
                showUploadArea();
                break;
            case 'l': // Lock Vault
                e.preventDefault();
                if (!state.isDemoMode) lockVault();
                break;
            case 'b': // Backup
                e.preventDefault();
                exportVault();
                break;
            case 'e': // Export Chat
                e.preventDefault();
                exportSummary();
                break;
        }
        
        // Number shortcuts (1-9) to switch documents
        if (e.key >= '1' && e.key <= '9') {
            e.preventDefault();
            const index = parseInt(e.key) - 1;
            if (state.documents[index]) {
                selectDocument(state.documents[index].id);
            }
        }
    }
};

// ==========================================
// RISK ANALYSIS
// ==========================================
const RISK_PATTERNS = {
    high: {
        label: 'HIGH RISK',
        color: 'high',
        description: 'Requires immediate legal review',
        patterns: [
            /indemnif|unlimited liability|waive.*claim|hold harmless|full liability|sole risk|unconditional|irrevocable|perpetual license|exclusive right|joint and several|personal guarantee/gi,
            /shall indemnify(?!.*mutually|.*each party)/gi, // One-sided indemnification
            /72\s*(business\s*)?days/gi, // Suspicious breach notification (should be 72 hours)
            /(?:12|6)\s*months?\s*(?:confidential|NDA|non-?disclosure)/gi // Short confidentiality period
        ]
    },
    medium: {
        label: 'MEDIUM RISK',
        color: 'medium',
        description: 'Review recommended before signing',
        patterns: [
            /confidential|exclusive|non-compete|penalty|liquidated damages|warranty|guarantee|automatic renewal|binding arbitration|limitation of liability|cap on damages/gi,
            /sole discretion|without cause|at will|unilateral/gi,
            /no liability|not liable|disclaims? all/gi
        ]
    },
    low: {
        label: 'STANDARD',
        color: 'low',
        description: 'Common contractual terms',
        patterns: [
            /payment term|notice period|termination|cancellation|standard|reasonable|mutual|either party may|governing law|jurisdiction/gi
        ]
    },
    missing: {
        label: 'MISSING CLAUSE',
        color: 'high',
        description: 'Expected clause not found',
        checkMissing: [
            { name: 'Mutual Indemnification', pattern: /mutual.*indemnif|each party.*indemnif|indemnif.*each other/gi },
            { name: 'Liability Cap', pattern: /liability.*(?:cap|limit|not exceed|maximum)/gi },
            { name: 'Data Breach Notification', pattern: /(?:72|seventy.?two)\s*hours?.*(?:breach|notify|notification)/gi },
            { name: 'Termination Rights', pattern: /(?:either party|both parties).*terminat/gi }
        ]
    }
};

async function analyzeRisks() {
    if (!state.currentChunks || state.currentChunks.length === 0) {
        addMessage('bot', '‚ö†Ô∏è Please upload a document first.');
        return;
    }
    
    // Log to Privacy Monitor
    logPrivacyEvent('Risk Analysis Started');
    
    // Ensure analysis view is visible
    setViewMode('analysis');
    
    addMessage('user', 'üö® Analyze risks in this document');
    
    const risks = {
        high: [],
        medium: [],
        low: [],
        missing: []
    };
    
    // Combine all text for missing clause check
    const fullText = state.currentChunks.map(c => c.text).join(' ');
    
    // Log local processing
    logPrivacyEvent('Pattern Matching (Local)');
    
    // Analyze each chunk for risks
    state.currentChunks.forEach((chunk, index) => {
        const text = chunk.text;
        
        for (const [level, config] of Object.entries(RISK_PATTERNS)) {
            if (level === 'missing') continue; // Handle separately
            if (!config.patterns) continue;
            
            for (const pattern of config.patterns) {
                const matches = text.match(pattern);
                if (matches) {
                    risks[level].push({
                        chunkIndex: index,
                        text: text.substring(0, 150) + '...',
                        matches: [...new Set(matches)].slice(0, 3),
                        fullText: text
                    });
                    break; // One match per level per chunk
                }
            }
        }
    });
    
    // Check for missing clauses in entire document
    if (RISK_PATTERNS.missing && RISK_PATTERNS.missing.checkMissing) {
        RISK_PATTERNS.missing.checkMissing.forEach(check => {
            if (!check.pattern.test(fullText)) {
                risks.missing.push({ name: check.name });
            }
        });
    }
    
    // Highlight chunks in UI
    document.querySelectorAll('.section-card').forEach(card => {
        card.classList.remove('risk-high', 'risk-medium', 'risk-low');
    });
    
    risks.high.forEach(r => {
        const card = document.querySelector(`.section-card[data-index="${r.chunkIndex}"]`);
        if (card) card.classList.add('risk-high');
    });
    risks.medium.forEach(r => {
        const card = document.querySelector(`.section-card[data-index="${r.chunkIndex}"]`);
        if (card) card.classList.add('risk-medium');
    });
    risks.low.forEach(r => {
        const card = document.querySelector(`.section-card[data-index="${r.chunkIndex}"]`);
        if (card) card.classList.add('risk-low');
    });
    
    // Calculate Risk Score (10 = safe, 0 = dangerous)
    const rawScore = 10 - 
        (risks.high.length * 2.5) -      // High risks = -2.5 each
        (risks.missing.length * 1.5) -   // Missing clauses = -1.5 each  
        (risks.medium.length * 0.5);     // Medium risks = -0.5 each
    const riskScore = Math.max(0, Math.min(10, rawScore)).toFixed(1);
    
    // Determine risk level label and color (different terminology than clause-level risks)
    let riskLevel, riskColor;
    if (riskScore >= 7) {
        riskLevel = 'Good';
        riskColor = '‚úÖ';
    } else if (riskScore >= 4) {
        riskLevel = 'Moderate';
        riskColor = 'üî∂';
    } else {
        riskLevel = 'Critical';
        riskColor = '‚ö†Ô∏è';
    }
    
    // Store for PDF export
    state.lastRiskAnalysis = {
        score: riskScore,
        level: riskLevel,
        risks: risks,
        timestamp: new Date().toISOString()
    };
    
    // Build visual progress bar (10 blocks)
    const filledBlocks = Math.round(parseFloat(riskScore));
    const progressBar = '‚ñà'.repeat(filledBlocks) + '‚ñë'.repeat(10 - filledBlocks);
    
    // Build response with visual badge
    let response = `**Contract Risk Assessment**\n\n`;
    
    // Safety Score Badge
    response += `‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
    response += `‚îÇ  ${riskColor} **SAFETY SCORE: ${riskScore} / 10**  ‚îÇ\n`;
    response += `‚îÇ     ${progressBar}      ‚îÇ\n`;
    response += `‚îÇ        *${riskLevel}*          ‚îÇ\n`;
    response += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
    
    // Summary
    response += `**Summary:**\n`;
    response += `üî¥ High Risk: ${risks.high.length} clause${risks.high.length !== 1 ? 's' : ''} requiring immediate review\n`;
    response += `üü° Medium Risk: ${risks.medium.length} clause${risks.medium.length !== 1 ? 's' : ''} requiring attention\n`;
    response += `‚ö†Ô∏è Missing: ${risks.missing.length} expected clause${risks.missing.length !== 1 ? 's' : ''} not found\n`;
    response += `üü¢ Standard: ${risks.low.length} clause${risks.low.length !== 1 ? 's' : ''}\n\n`;
    
    // Missing clauses (show first!)
    if (risks.missing.length > 0) {
        response += `**‚ö†Ô∏è MISSING CLAUSES - Action Required:**\n`;
        risks.missing.forEach((m, i) => {
            response += `${i+1}. **${m.name}** not found in document\n`;
        });
        response += `\n`;
    }
    
    // High risks detail
    if (risks.high.length > 0) {
        response += `**HIGH RISK - Immediate Legal Review Required:**\n`;
        risks.high.slice(0, 3).forEach((r, i) => {
            response += `${i+1}. **Issue:** ${r.matches.join(', ')} clause detected\n`;
            response += `   *"${r.text}"*\n\n`;
        });
    }
    
    // Medium risks detail
    if (risks.medium.length > 0) {
        response += `**MEDIUM RISK - Review Recommended:**\n`;
        risks.medium.slice(0, 3).forEach((r, i) => {
            response += `${i+1}. **Issue:** ${r.matches.join(', ')} clause detected\n`;
            response += `   *"${r.text}"*\n\n`;
        });
    }
    
    // Recommendations
    response += `\nüí° **Recommendations:**\n`;
    if (risks.missing.length > 0) {
        response += `‚Ä¢ Request missing clauses before signing\n`;
    }
    if (risks.high.length > 0) {
        response += `‚Ä¢ Review high-risk clauses with legal counsel\n`;
        response += `‚Ä¢ Consider negotiating indemnification limits\n`;
    }
    if (risks.medium.length > 0) {
        response += `‚Ä¢ Verify confidentiality terms are mutual\n`;
        response += `‚Ä¢ Check non-compete scope and duration\n`;
    }
    if (risks.high.length === 0 && risks.medium.length === 0) {
        response += `‚Ä¢ Document appears relatively low-risk\n`;
        response += `‚Ä¢ Standard review recommended before signing\n`;
    }
    
    addMessage('bot', response);
    
    // Force DOM reflow to ensure message renders immediately
    const chatArea = document.getElementById('chatArea');
    void chatArea.offsetHeight; // Force synchronous reflow
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Scroll to first high risk chunk
    if (risks.high.length > 0) {
        const firstHighRisk = document.querySelector('.section-card.risk-high');
        if (firstHighRisk) {
            firstHighRisk.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    // Log completion
    logPrivacyEvent('Analysis Complete');
    
    logAudit('risk_analysis', `Safety Score: ${riskScore}/10 (${riskLevel}). Found ${risks.high.length} high, ${risks.medium.length} medium, ${risks.low.length} low risk items`);
    
    // Prompt for feedback after user has time to review results (Beta)
    setTimeout(() => {
        showFeedback();
    }, 8000); // 8 seconds to review before asking
}

// ==========================================
// THEME TOGGLE (Dark/Light)
// ==========================================
function toggleTheme() {
    document.body.classList.toggle('light-theme');
    const isLight = document.body.classList.contains('light-theme');
    document.getElementById('themeToggle').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('regsecure-theme', isLight ? 'light' : 'dark');
}

// Load saved theme
if (localStorage.getItem('regsecure-theme') === 'light') {
    document.body.classList.add('light-theme');
    document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
}

// ==========================================
// PRINT VIEW
// ==========================================
function printChat() {
    window.print();
}

// ==========================================
// CHUNK NAVIGATOR
// ==========================================
// (Legacy navigation removed - using new section cards)
// ==========================================

// ==========================================
// DOCUMENT STATS
// ==========================================
function showDocStats() {
    if (!state.currentDocId) return;
    
    const doc = state.documents.find(d => d.id === state.currentDocId);
    if (!doc) return;
    
    const chunks = state.currentChunks || [];
    const totalText = chunks.map(c => c.text).join(' ');
    const words = totalText.split(/\s+/).filter(w => w.length > 0).length;
    const chars = totalText.length;
    const sentences = totalText.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
    
    // Extract dates
    const datePattern = /\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2}/g;
    const dates = [...new Set(totalText.match(datePattern) || [])];
    
    // Extract money amounts
    const moneyPattern = /[\$‚Ç¨‚Ç™]\s*[\d,]+(?:\.\d{2})?|\d{1,3}(?:,\d{3})*(?:\.\d{2})?\s*(?:USD|EUR|ILS|NIS|◊©◊ß◊ú|◊ì◊ï◊ú◊®)/gi;
    const amounts = [...new Set(totalText.match(moneyPattern) || [])];
    
    document.getElementById('statsContent').innerHTML = `
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-blue-400">${words.toLocaleString()}</p>
                <p class="text-[10px] text-slate-500">Words</p>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-blue-300">${chunks.length}</p>
                <p class="text-[10px] text-slate-500">Chunks</p>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-green-600">${sentences}</p>
                <p class="text-[10px] text-slate-500">Sentences</p>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-amber-400">${chars.toLocaleString()}</p>
                <p class="text-[10px] text-slate-500">Characters</p>
            </div>
        </div>
        ${dates.length > 0 ? `
            <div class="bg-slate-800/50 rounded-lg p-3 mt-3">
                <p class="text-xs font-semibold text-white mb-2">üìÖ Dates Found (${dates.length})</p>
                <div class="flex flex-wrap gap-1">
                    ${dates.slice(0, 10).map(d => `<span class="text-[10px] bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded">${d}</span>`).join('')}
                    ${dates.length > 10 ? `<span class="text-[10px] text-slate-500">+${dates.length - 10} more</span>` : ''}
                </div>
            </div>
        ` : ''}
        ${amounts.length > 0 ? `
            <div class="bg-slate-800/50 rounded-lg p-3 mt-3">
                <p class="text-xs font-semibold text-white mb-2">üí∞ Amounts Found (${amounts.length})</p>
                <div class="flex flex-wrap gap-1">
                    ${amounts.slice(0, 10).map(a => `<span class="text-[10px] bg-green-600/20 text-green-500 px-2 py-0.5 rounded">${a}</span>`).join('')}
                    ${amounts.length > 10 ? `<span class="text-[10px] text-slate-500">+${amounts.length - 10} more</span>` : ''}
                </div>
            </div>
        ` : ''}
        <div class="bg-slate-800/50 rounded-lg p-3 mt-3">
            <p class="text-xs font-semibold text-white mb-2">üìÑ Document Info</p>
            <div class="text-[10px] text-slate-400 space-y-1">
                <p>Name: ${doc.name}</p>
                <p>Type: ${doc.fileType || 'PDF'}</p>
                <p>OCR: ${doc.usedOCR ? 'Yes' : 'No'}</p>
                <p>Created: ${new Date(doc.createdAt).toLocaleString()}</p>
            </div>
        </div>
    `;
    
    document.getElementById('statsModal').classList.remove('hidden');
}

function closeStatsModal() {
    document.getElementById('statsModal').classList.add('hidden');
}

// ==========================================
// COMPARE DOCUMENTS
// ==========================================
function showCompareMode() {
    if (state.documents.length < 2) {
        showToast('Need at least 2 documents to compare', 'error');
        return;
    }
    
    const select1 = document.getElementById('compareDoc1');
    const select2 = document.getElementById('compareDoc2');
    
    const options = state.documents.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    select1.innerHTML = '<option value="">Select document...</option>' + options;
    select2.innerHTML = '<option value="">Select document...</option>' + options;
    
    document.getElementById('compareResults').classList.add('hidden');
    document.getElementById('compareModal').classList.remove('hidden');
}

function closeCompareModal() {
    document.getElementById('compareModal').classList.add('hidden');
}

async function runComparison() {
    const doc1Id = document.getElementById('compareDoc1').value;
    const doc2Id = document.getElementById('compareDoc2').value;
    
    if (!doc1Id || !doc2Id || doc1Id === doc2Id) {
        showToast('Please select two different documents', 'error');
        return;
    }
    
    const doc1 = state.documents.find(d => d.id === doc1Id);
    const doc2 = state.documents.find(d => d.id === doc2Id);
    
    const chunks1 = await loadVectors(doc1Id);
    const chunks2 = await loadVectors(doc2Id);
    
    const text1 = chunks1.map(c => c.text).join('\n\n');
    const text2 = chunks2.map(c => c.text).join('\n\n');
    
    // Simple comparison - find unique content
    const words1 = new Set(text1.toLowerCase().split(/\s+/));
    const words2 = new Set(text2.toLowerCase().split(/\s+/));
    
    const onlyIn1 = [...words1].filter(w => !words2.has(w) && w.length > 4);
    const onlyIn2 = [...words2].filter(w => !words1.has(w) && w.length > 4);
    
    document.getElementById('compareLeft').innerHTML = `
        <h4 class="font-semibold text-white mb-2">${doc1.name}</h4>
        <p class="text-slate-400 mb-2">${chunks1.length} chunks, ${text1.split(/\s+/).length} words</p>
        <div class="border-t border-slate-700 pt-2 mt-2">
            <p class="text-[10px] text-slate-500 mb-1">Unique terms (${onlyIn1.length}):</p>
            <div class="flex flex-wrap gap-1">
                ${onlyIn1.slice(0, 20).map(w => `<span class="text-[9px] bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded">${w}</span>`).join('')}
            </div>
        </div>
    `;
    
    document.getElementById('compareRight').innerHTML = `
        <h4 class="font-semibold text-white mb-2">${doc2.name}</h4>
        <p class="text-slate-400 mb-2">${chunks2.length} chunks, ${text2.split(/\s+/).length} words</p>
        <div class="border-t border-slate-700 pt-2 mt-2">
            <p class="text-[10px] text-slate-500 mb-1">Unique terms (${onlyIn2.length}):</p>
            <div class="flex flex-wrap gap-1">
                ${onlyIn2.slice(0, 20).map(w => `<span class="text-[9px] bg-green-600/20 text-green-500 px-1.5 py-0.5 rounded">${w}</span>`).join('')}
            </div>
        </div>
    `;
    
    // Calculate similarity
    const intersection = [...words1].filter(w => words2.has(w)).length;
    const union = new Set([...words1, ...words2]).size;
    const similarity = Math.round((intersection / union) * 100);
    
    document.getElementById('compareSummary').innerHTML = `
        <h4 class="font-semibold text-white mb-2">üìä Comparison Summary</h4>
        <div class="grid grid-cols-3 gap-4 mb-3">
            <div class="text-center">
                <p class="text-xl font-bold text-blue-400">${similarity}%</p>
                <p class="text-[10px] text-slate-500">Similarity</p>
            </div>
            <div class="text-center">
                <p class="text-xl font-bold text-red-400">${onlyIn1.length}</p>
                <p class="text-[10px] text-slate-500">Only in Doc 1</p>
            </div>
            <div class="text-center">
                <p class="text-xl font-bold text-green-600">${onlyIn2.length}</p>
                <p class="text-[10px] text-slate-500">Only in Doc 2</p>
            </div>
        </div>
        <p class="text-xs text-slate-400">
            ${similarity > 80 ? '‚úÖ Documents are very similar' : 
              similarity > 50 ? '‚ö†Ô∏è Documents have significant differences' :
              '‚ùå Documents are substantially different'}
        </p>
    `;
    
    document.getElementById('compareResults').classList.remove('hidden');
    logAudit('compare', `Compared ${doc1.name} vs ${doc2.name}: ${similarity}% similar`);
}

// ==========================================
// CLAUSE LIBRARY
// ==========================================
let clauseLibrary = JSON.parse(localStorage.getItem('regsecure-clauses') || '[]');

function showClauseLibrary() {
    renderClauseList();
    document.getElementById('clauseModal').classList.remove('hidden');
}

function closeClauseModal() {
    document.getElementById('clauseModal').classList.add('hidden');
}

function renderClauseList() {
    const list = document.getElementById('clauseList');
    if (clauseLibrary.length === 0) {
        list.innerHTML = '<p class="text-slate-500 text-sm text-center py-8">No saved clauses yet</p>';
        return;
    }
    
    list.innerHTML = clauseLibrary.map((clause, i) => `
        <div class="bg-slate-800/50 rounded-lg p-3 group">
            <div class="flex justify-between items-start mb-2">
                <span class="text-[10px] bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded">${clause.label || 'Clause ' + (i+1)}</span>
                <div class="flex gap-1">
                    <button onclick="copyClause(${i})" class="text-slate-500 hover:text-white text-xs">üìã</button>
                    <button onclick="deleteClause(${i})" class="text-slate-500 hover:text-red-400 text-xs">üóëÔ∏è</button>
                </div>
            </div>
            <p class="text-xs text-slate-300" style="direction: ${detectTextDirection(clause.text)}">${clause.text}</p>
            <p class="text-[9px] text-slate-600 mt-2">From: ${clause.source} ‚Ä¢ ${new Date(clause.savedAt).toLocaleDateString()}</p>
        </div>
    `).join('');
}

function saveCurrentSelection() {
    const selection = window.getSelection().toString().trim();
    if (!selection) {
        showToast('Please select some text first', 'error');
        return;
    }
    
    const label = prompt('Label for this clause:', 'Important Clause');
    if (!label) return;
    
    const doc = state.documents.find(d => d.id === state.currentDocId);
    
    clauseLibrary.push({
        text: selection,
        label: label,
        source: doc?.name || 'Unknown',
        savedAt: Date.now()
    });
    
    localStorage.setItem('regsecure-clauses', JSON.stringify(clauseLibrary));
    renderClauseList();
    showToast('Clause saved!', 'success');
    logAudit('clause_saved', label);
}

function copyClause(index) {
    navigator.clipboard.writeText(clauseLibrary[index].text);
    showToast('Copied to clipboard!', 'success');
}

function deleteClause(index) {
    if (confirm('Delete this clause?')) {
        clauseLibrary.splice(index, 1);
        localStorage.setItem('regsecure-clauses', JSON.stringify(clauseLibrary));
        renderClauseList();
    }
}

// ==========================================
// DASHBOARD
// ==========================================
let sessionStartTime = Date.now();
let queryCount = 0;

function showDashboard() {
    const elapsed = Math.round((Date.now() - sessionStartTime) / 60000);
    
    document.getElementById('dashTotalDocs').textContent = state.documents.length;
    document.getElementById('dashTotalQueries').textContent = queryCount;
    document.getElementById('dashSessionTime').textContent = elapsed + 'm';
    
    // Recent activity from audit log
    const recentActivity = state.auditLog.slice(-10).reverse();
    document.getElementById('dashRecentActivity').innerHTML = recentActivity.length > 0 
        ? recentActivity.map(a => `
            <div class="flex justify-between text-slate-400">
                <span>${a.action}: ${a.details?.substring(0, 30) || ''}...</span>
                <span class="text-slate-600">${new Date(a.timestamp).toLocaleTimeString()}</span>
            </div>
        `).join('')
        : '<p class="text-slate-600">No recent activity</p>';
    
    // Document stats
    document.getElementById('dashDocStats').innerHTML = state.documents.map(d => `
        <div class="flex justify-between text-slate-400">
            <span>${d.name.substring(0, 25)}${d.name.length > 25 ? '...' : ''}</span>
            <span>${d.chunkCount} chunks</span>
        </div>
    `).join('') || '<p class="text-slate-600">No documents</p>';
    
    document.getElementById('dashboardModal').classList.remove('hidden');
}

function closeDashboard() {
    document.getElementById('dashboardModal').classList.add('hidden');
}

// ==========================================
// SETTINGS
// ==========================================
function showSettings() {
    document.getElementById('settingsModal').classList.remove('hidden');
}

function closeSettings() {
    document.getElementById('settingsModal').classList.add('hidden');
}

// ==========================================
// PRIVACY MONITOR
// ==========================================
const privacyMonitor = {
    log: [],
    bytesOut: 0,
    blocked: 0,
    localOps: 0,
    observer: null,
    
    init() {
        // Use PerformanceObserver to track real network requests
        if (typeof PerformanceObserver !== 'undefined') {
            this.observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.initiatorType === 'fetch' || entry.initiatorType === 'xmlhttprequest') {
                        this.logNetworkRequest(entry);
                    }
                }
            });
            try {
                this.observer.observe({ entryTypes: ['resource'] });
            } catch (e) {
                console.log('PerformanceObserver not fully supported');
            }
        }
        
        // Intercept fetch to monitor outgoing requests
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            const url = args[0]?.url || args[0];
            this.logRequest('fetch', url);
            return originalFetch.apply(window, args);
        };
        
        // Intercept XMLHttpRequest
        const originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(...args) {
            privacyMonitor.logRequest('xhr', args[1]);
            return originalXHROpen.apply(this, args);
        };
    },
    
    logNetworkRequest(entry) {
        const url = new URL(entry.name);
        const isAllowed = this.isAllowedDomain(url.hostname);
        const size = entry.transferSize || 0;
        
        if (!isAllowed) {
            this.blocked++;
        }
        
        this.addLogEntry({
            time: new Date(),
            type: isAllowed ? 'allowed' : 'blocked',
            domain: url.hostname,
            path: url.pathname.substring(0, 30),
            size: size
        });
    },
    
    logRequest(type, url) {
        try {
            const urlObj = new URL(url, window.location.origin);
            if (urlObj.protocol === 'blob:' || urlObj.protocol === 'data:') {
                return; // Ignore blob/data URLs (local)
            }
            
            const isAllowed = this.isAllowedDomain(urlObj.hostname);
            if (!isAllowed && urlObj.hostname !== window.location.hostname) {
                this.blocked++;
                this.addLogEntry({
                    time: new Date(),
                    type: 'blocked',
                    domain: urlObj.hostname,
                    path: urlObj.pathname.substring(0, 30),
                    size: 0
                });
            }
        } catch (e) {
            // Relative URL, local request
        }
    },
    
    isAllowedDomain(hostname) {
        const allowed = [
            'cdn.jsdelivr.net',
            'cdnjs.cloudflare.com',
            'fonts.googleapis.com',
            'fonts.gstatic.com',
            'unpkg.com',
            window.location.hostname
        ];
        return allowed.some(d => hostname.includes(d));
    },
    
    logLocalOperation(operation) {
        this.localOps++;
        this.addLogEntry({
            time: new Date(),
            type: 'local',
            operation: operation,
            size: 0
        });
        this.updateUI();
    },
    
    addLogEntry(entry) {
        this.log.unshift(entry);
        if (this.log.length > 100) this.log.pop();
        this.updateUI();
    },
    
    updateUI() {
        const logEl = document.getElementById('privacyLog');
        const outboundEl = document.getElementById('privacyOutbound');
        const blockedEl = document.getElementById('privacyBlocked');
        const localEl = document.getElementById('privacyLocal');
        
        if (!logEl) return;
        
        outboundEl.textContent = this.bytesOut;
        blockedEl.textContent = this.blocked;
        localEl.textContent = this.localOps;
        
        if (this.log.length === 0) {
            logEl.innerHTML = '<div class="text-slate-600 italic">Monitoring network activity...</div>';
            return;
        }
        
        logEl.innerHTML = this.log.slice(0, 50).map(entry => {
            const time = entry.time.toLocaleTimeString();
            if (entry.type === 'local') {
                return `<div class="text-green-500">[${time}] ‚úì ${entry.operation} <span class="text-green-700">0 KB ‚¨ÜÔ∏è</span></div>`;
            } else if (entry.type === 'allowed') {
                return `<div class="text-blue-400">[${time}] ‚Üó ${entry.domain} <span class="text-blue-600">${this.formatSize(entry.size)}</span></div>`;
            } else {
                return `<div class="text-red-400">[${time}] ‚úó BLOCKED: ${entry.domain}</div>`;
            }
        }).join('');
    },
    
    formatSize(bytes) {
        if (bytes === 0) return '0 B';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    },
    
    clear() {
        this.log = [];
        this.updateUI();
    }
};

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    privacyMonitor.init();
    
    // WebGPU support check
    if (!navigator.gpu) {
        document.getElementById('webgpuWarning').classList.remove('hidden');
        console.warn('‚ö†Ô∏è WebGPU not supported - AI features will be limited');
    }
});

function showPrivacyMonitor() {
    document.getElementById('privacyMonitorModal').classList.remove('hidden');
    privacyMonitor.updateUI();
}

function hidePrivacyMonitor() {
    document.getElementById('privacyMonitorModal').classList.add('hidden');
}

function clearPrivacyLog() {
    privacyMonitor.clear();
}

// Helper to log local operations from other parts of the app
function logPrivacyEvent(operation) {
    privacyMonitor.logLocalOperation(operation);
}

async function changePassword() {
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    
    if (!current || !newPass || !confirm) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    if (newPass !== confirm) {
        showToast('New passwords do not match', 'error');
        return;
    }
    
    if (newPass.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
    }
    
    try {
        // Verify current password
        const testKey = await Crypto.deriveKey(current, state.salt);
        const testDoc = await DB.getAll('documents');
        if (testDoc.length > 0) {
            try {
                await Crypto.decrypt(new Uint8Array(testDoc[0].data), testKey);
            } catch {
                showToast('Current password is incorrect', 'error');
                return;
            }
        }
        
        // Re-encrypt everything with new password
        const newSalt = crypto.getRandomValues(new Uint8Array(16));
        const newKey = await Crypto.deriveKey(newPass, newSalt);
        
        // Re-encrypt documents
        for (const doc of state.documents) {
            const encrypted = await Crypto.encrypt(doc, newKey);
            await DB.put('documents', { id: doc.id, data: Array.from(encrypted) });
        }
        
        // Re-encrypt vectors
        for (const doc of state.documents) {
            const vectors = await loadVectors(doc.id);
            await DB.deleteByIndex('vectors', 'docId', doc.id);
            for (const chunk of vectors) {
                const encrypted = await Crypto.encrypt(chunk, newKey);
                await DB.put('vectors', { docId: doc.id, data: Array.from(encrypted) });
            }
        }
        
        // Save new salt
        await DB.put('meta', { key: 'salt', value: Array.from(newSalt) });
        
        state.salt = newSalt;
        state.encryptionKey = newKey;
        
        showToast('Password changed successfully!', 'success');
        closeSettings();
        logAudit('password_changed', 'Password updated');
        
    } catch (e) {
        showToast('Error changing password: ' + e.message, 'error');
    }
    
    // Clear fields
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
}

let duressPassword = localStorage.getItem('regsecure-duress') || null;

function setDuressPassword() {
    const pass = document.getElementById('duressPassword').value;
    if (!pass || pass.length < 4) {
        showToast('Duress password must be at least 4 characters', 'error');
        return;
    }
    
    duressPassword = pass;
    localStorage.setItem('regsecure-duress', pass);
    showToast('Duress password set! If entered at login, all data will be wiped.', 'success');
    document.getElementById('duressPassword').value = '';
    logAudit('duress_set', 'Duress password configured');
}

function updateTimeout() {
    const minutes = parseInt(document.getElementById('timeoutSelect').value);
    state.sessionTimeout = minutes === 0 ? Infinity : minutes * 60 * 1000;
    logAudit('timeout_changed', `Set to ${minutes} minutes`);
}

// Check duress on unlock - override original unlockVault
const originalUnlockVault = unlockVault;
unlockVault = async function() {
    const password = document.getElementById('masterPassword').value;
    
    // Check if duress password
    if (duressPassword && password === duressPassword) {
        if (confirm('‚ö†Ô∏è DURESS MODE ACTIVATED\n\nThis will permanently delete ALL data.\n\nContinue?')) {
            await DB.db.transaction(['documents', 'vectors', 'conversations', 'meta'], 'readwrite');
            const tx = DB.db.transaction(['documents', 'vectors', 'conversations', 'meta'], 'readwrite');
            tx.objectStore('documents').clear();
            tx.objectStore('vectors').clear();
            tx.objectStore('conversations').clear();
            tx.objectStore('meta').clear();
            localStorage.removeItem('regsecure-clauses');
            localStorage.removeItem('regsecure-duress');
            showToast('All data has been wiped.', 'info');
            location.reload();
        }
        return;
    }
    
    return originalUnlockVault();
};

// Auto-generate summary on document load
const originalSelectDocumentForSummary = selectDocument;
selectDocument = async function(docId) {
    await originalSelectDocumentForSummary(docId);
    updateChunkNav();
    queryCount++; // Count document opens
};

// Track queries
const originalHandleChatForTracking = handleChat;
handleChat = async function() {
    queryCount++;
    return originalHandleChatForTracking();
};

// ==========================================
// ONBOARDING TOUR
// ==========================================
function initTour() {
    const hasSeenTour = localStorage.getItem('regsecure_tour_seen');
    if (!hasSeenTour && !state.isDemoMode) {
        setTimeout(() => {
            document.getElementById('tourModal').classList.remove('hidden');
            updateTourDots(1);
        }, 500);
    }
}

function nextTourStep(step) {
    document.querySelectorAll('.tour-step').forEach(el => el.classList.add('hidden'));
    document.getElementById(`tourStep${step}`).classList.remove('hidden');
    updateTourDots(step);
}

function updateTourDots(step) {
    for (let i = 1; i <= 4; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (i === step) {
            dot.className = 'w-2 h-2 rounded-full bg-white scale-125 tour-dot transition-all';
        } else if (i < step) {
            dot.className = 'w-2 h-2 rounded-full bg-blue-500 tour-dot transition-all';
        } else {
            dot.className = 'w-2 h-2 rounded-full bg-slate-700 tour-dot transition-all';
        }
    }
}

function closeTour() {
    document.getElementById('tourModal').classList.add('hidden');
    localStorage.setItem('regsecure_tour_seen', 'true');
}

function resetTour() {
    localStorage.removeItem('regsecure_tour_seen');
    document.querySelectorAll('.tour-step').forEach(el => el.classList.add('hidden'));
    document.getElementById('tourStep1').classList.remove('hidden');
    document.getElementById('tourModal').classList.remove('hidden');
    updateTourDots(1);
}

function toggleHelp() {
    const modal = document.getElementById('helpModal');
    modal.classList.toggle('hidden');
}

// ==========================================
// ABOUT MODAL
// ==========================================
function showAbout() {
    document.getElementById('aboutModal').classList.remove('hidden');
}

function hideAbout() {
    document.getElementById('aboutModal').classList.add('hidden');
}

// ==========================================
// FEEDBACK SYSTEM
// ==========================================
let feedbackType = 'other';

function showFeedback() {
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function hideFeedback() {
    document.getElementById('feedbackModal').classList.add('hidden');
    document.getElementById('feedbackText').value = '';
    feedbackType = 'other';
    // Reset button styles
    ['bug', 'feature', 'other'].forEach(t => {
        document.getElementById('fbType' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('bg-blue-500/20', 'border-blue-500/30', 'text-blue-400');
    });
}

function setFeedbackType(type) {
    feedbackType = type;
    // Reset all buttons
    ['bug', 'feature', 'other'].forEach(t => {
        const btn = document.getElementById('fbType' + t.charAt(0).toUpperCase() + t.slice(1));
        btn.classList.remove('bg-blue-500/20', 'border-blue-500/30', 'text-blue-400', 'bg-red-500/20', 'border-red-500/30', 'text-red-400');
    });
    // Highlight selected
    const selectedBtn = document.getElementById('fbType' + type.charAt(0).toUpperCase() + type.slice(1));
    if (type === 'bug') {
        selectedBtn.classList.add('bg-red-500/20', 'border-red-500/30', 'text-red-400');
    } else {
        selectedBtn.classList.add('bg-blue-500/20', 'border-blue-500/30', 'text-blue-400');
    }
}

function submitFeedback() {
    const text = document.getElementById('feedbackText').value.trim();
    if (!text) {
        showToast('Please enter your feedback', 'error');
        return;
    }
    
    // In production, this would send to a server
    // For now, create a mailto link
    const subject = encodeURIComponent(`[RegSecure Feedback] ${feedbackType.toUpperCase()}`);
    const body = encodeURIComponent(`Type: ${feedbackType}\n\nFeedback:\n${text}\n\n---\nSent from RegSecure AI Pro v1.0 Beta`);
    
    window.open(`mailto:arnon@particular.co.il?subject=${subject}&body=${body}`);
    
    showToast('Thank you for your feedback!', 'success');
    hideFeedback();
    logAudit('feedback', `Submitted ${feedbackType} feedback`);
}

// ==========================================
// OFFLINE DETECTION
// ==========================================
function updateOnlineStatus() {
    const indicator = document.getElementById('offlineIndicator');
    if (!navigator.onLine) {
        indicator.classList.remove('hidden');
        indicator.classList.add('flex');
    } else {
        indicator.classList.add('hidden');
        indicator.classList.remove('flex');
    }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
// Check on load
setTimeout(updateOnlineStatus, 1000);

// ==========================================
// SYSTEM STATUS (Unified Indicator)
// ==========================================
function showSystemDetails() {
    document.getElementById('systemDetailsModal').classList.remove('hidden');
}

function hideSystemDetails() {
    document.getElementById('systemDetailsModal').classList.add('hidden');
}

function updateUnifiedStatus() {
    const workerReady = document.getElementById('workerStatus')?.dataset?.ready === 'true';
    const ocrReady = document.getElementById('ocrStatus')?.dataset?.ready === 'true';
    const llmReady = document.getElementById('llmStatus')?.dataset?.ready === 'true';
    
    const statusDot = document.getElementById('systemStatusDot');
    const statusText = document.getElementById('systemStatusText');
    
    // Update detail modal (with null checks)
    const detailWorker = document.getElementById('detailWorker');
    const detailOCR = document.getElementById('detailOCR');
    const detailLLM = document.getElementById('detailLLM');
    
    if (detailWorker) {
        const span = detailWorker.querySelector('span:last-child');
        if (span) {
            span.textContent = workerReady ? '‚úì Ready' : 'Loading...';
            span.className = workerReady ? 'text-green-600 text-xs' : 'text-yellow-400 text-xs';
        }
    }
    
    if (detailOCR) {
        const span = detailOCR.querySelector('span:last-child');
        if (span) {
            span.textContent = ocrReady ? '‚úì Ready' : 'Loading...';
            span.className = ocrReady ? 'text-green-600 text-xs' : 'text-yellow-400 text-xs';
        }
    }
    
    if (detailLLM) {
        const span = detailLLM.querySelector('span:last-child');
        if (span) {
            span.textContent = llmReady ? '‚úì Ready' : 'Optional';
            span.className = llmReady ? 'text-green-600 text-xs' : 'text-slate-400 text-xs';
        }
    }
    
    // Update unified indicator - green when embedding is ready
    if (workerReady) {
        statusDot.className = 'w-2 h-2 rounded-full bg-green-600';
        statusText.textContent = '100% Local';
        statusText.className = 'text-green-600';
    } else {
        statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
        statusText.textContent = 'Initializing...';
        statusText.className = 'text-yellow-400';
    }
}

// Override status update functions to also update unified status
const origUpdateWorkerStatus = window.updateWorkerStatus;
if (origUpdateWorkerStatus) {
    window.updateWorkerStatus = function(ready) {
        origUpdateWorkerStatus(ready);
        document.getElementById('workerStatus').dataset.ready = ready ? 'true' : 'false';
        updateUnifiedStatus();
    };
}

// ==========================================
// SAMPLE DOCUMENTS
// ==========================================
const SAMPLE_DOCUMENTS = {
    nda: {
        name: 'Sample NDA.txt',
        content: `MUTUAL NON-DISCLOSURE AGREEMENT

This Mutual Non-Disclosure Agreement ("Agreement") is entered into as of [DATE] by and between:

Party A: [COMPANY A]
Party B: [COMPANY B]

1. DEFINITION OF CONFIDENTIAL INFORMATION
"Confidential Information" means any information disclosed by either party to the other, including but not limited to: trade secrets, business plans, customer lists, financial data, and technical specifications.

2. CONFIDENTIALITY OBLIGATIONS
Each party agrees to:
a) Hold the other party's Confidential Information in strict confidence
b) Not disclose Confidential Information to third parties without prior written consent
c) Use Confidential Information only for the purposes of evaluating a potential business relationship

3. TERM OF CONFIDENTIALITY
‚ö†Ô∏è The obligations of confidentiality shall remain in effect for a period of twelve (12) months from the date of disclosure.

4. EXCLUSIONS
Confidential Information does not include information that:
a) Is or becomes publicly available through no fault of the receiving party
b) Was known to the receiving party prior to disclosure
c) Is independently developed without use of Confidential Information

5. INDEMNIFICATION
Each party shall indemnify and hold harmless the other party from any damages arising from unauthorized disclosure of Confidential Information.

6. GOVERNING LAW
This Agreement shall be governed by the laws of [JURISDICTION].

SIGNATURES:
Party A: _________________ Date: _______
Party B: _________________ Date: _______`
    },
    saas: {
        name: 'Sample SaaS Agreement.txt',
        content: `SOFTWARE AS A SERVICE AGREEMENT

This SaaS Agreement ("Agreement") is made between:
Provider: TechCorp Solutions Inc.
Customer: [CUSTOMER NAME]

1. SERVICE DESCRIPTION
Provider agrees to provide Customer with access to the CloudManager platform ("Service").

2. SUBSCRIPTION TERM
Initial Term: 12 months from Effective Date
Renewal: ‚ö†Ô∏è Automatic renewal for successive 12-month periods unless terminated with 30 days notice.

3. FEES AND PAYMENT
Monthly Fee: $5,000
Payment Terms: Net 30
Late Payment: 1.5% per month

4. DATA OWNERSHIP
Customer retains all rights to Customer Data. Provider may use aggregated, anonymized data for service improvement.

5. SERVICE LEVEL AGREEMENT
Uptime Guarantee: 99.9%
Support Response: Within 4 business hours

6. LIMITATION OF LIABILITY
‚ö†Ô∏è PROVIDER'S TOTAL LIABILITY SHALL NOT EXCEED THE FEES PAID IN THE TWELVE (12) MONTHS PRECEDING THE CLAIM.

Provider shall not be liable for:
- Indirect, incidental, or consequential damages
- Loss of profits or data
- Third-party claims

7. INDEMNIFICATION
‚ö†Ô∏è Customer shall indemnify and hold harmless Provider from any claims arising from Customer's use of the Service.

8. TERMINATION
Either party may terminate for material breach with 30 days written notice and opportunity to cure.

9. GOVERNING LAW
This Agreement shall be governed by the laws of Delaware.

ACCEPTED AND AGREED:
Provider: _________________ Date: _______
Customer: _________________ Date: _______`
    },
    dpa: {
        name: 'Sample DPA.txt',
        content: `DATA PROCESSING AGREEMENT

This Data Processing Agreement ("DPA") supplements the Service Agreement between:
Controller: [COMPANY NAME] ("Controller")
Processor: DataSecure Inc. ("Processor")

1. DEFINITIONS
"Personal Data" means any information relating to an identified or identifiable natural person.
"Processing" means any operation performed on Personal Data.

2. SCOPE OF PROCESSING
Processor shall process Personal Data only:
a) On documented instructions from Controller
b) For the purposes specified in the Service Agreement
c) In compliance with applicable data protection laws

3. SECURITY MEASURES
Processor shall implement appropriate technical and organizational measures including:
- Encryption of Personal Data in transit and at rest
- Access controls and authentication
- Regular security assessments
- Employee training

4. DATA BREACH NOTIFICATION
‚ö†Ô∏è In the event of a Personal Data breach, Processor shall notify Controller within 72 business days of becoming aware of the breach.

Notification shall include:
- Nature of the breach
- Categories of data affected
- Approximate number of individuals affected
- Measures taken to address the breach

5. SUB-PROCESSORS
Processor shall not engage sub-processors without Controller's prior written consent.

6. DATA SUBJECT RIGHTS
Processor shall assist Controller in responding to data subject requests for:
- Access to Personal Data
- Rectification or erasure
- Data portability

7. DATA RETENTION
Upon termination, Processor shall delete or return all Personal Data within 30 days.

8. AUDIT RIGHTS
Controller may audit Processor's compliance with this DPA upon reasonable notice.

SIGNATURES:
Controller: _________________ Date: _______
Processor: _________________ Date: _______`
    }
};

function loadSampleDocument(type) {
    const sample = SAMPLE_DOCUMENTS[type];
    if (!sample) return;
    
    // Create a mock file-like object
    const content = sample.content;
    const name = sample.name;
    
    // Process it like a regular document
    processSampleDocument(name, content);
    showToast(`Loaded sample: ${name}`, 'success');
}

async function processSampleDocument(name, content) {
    // Generate ID
    const id = 'sample_' + Date.now();
    
    // Split into chunks
    const chunks = [];
    const sentences = content.split(/(?<=[.!?])\s+/);
    let currentChunk = '';
    
    for (const sentence of sentences) {
        if ((currentChunk + sentence).length > 500) {
            if (currentChunk) chunks.push({ text: currentChunk.trim(), type: 'paragraph' });
            currentChunk = sentence;
        } else {
            currentChunk += ' ' + sentence;
        }
    }
    if (currentChunk) chunks.push({ text: currentChunk.trim(), type: 'paragraph' });
    
    // Store document WITH chunks
    const doc = {
        id,
        name,
        type: 'text/plain',
        size: content.length,
        content,
        chunks,  // Store chunks in doc!
        uploadedAt: new Date().toISOString(),
        isSample: true
    };
    
    state.documents.push(doc);
    state.currentDocId = id;
    state.currentChunks = chunks;
    
    // Update UI
    renderDocumentList();
    renderSectionsGrid();
    
    // Show content area with Analysis view
    document.getElementById('uploadArea').classList.add('hidden');
    document.getElementById('processingArea').classList.add('hidden');
    document.getElementById('viewToggle').classList.remove('hidden');
    document.getElementById('suggestionsArea').classList.remove('hidden');
    setViewMode('analysis');
    enableChat();
    
    // Generate embeddings if available
    if (state.embeddingPipeline) {
        addMessage('bot', `üìÑ Loaded **${name}**. Generating embeddings...`);
        try {
            for (let i = 0; i < chunks.length; i++) {
                const result = await state.embeddingPipeline(chunks[i].text, { pooling: 'mean', normalize: true });
                chunks[i].embedding = Array.from(result.data);
            }
            addMessage('bot', `‚úÖ Ready! Found ${chunks.length} sections. Try asking about indemnification, confidentiality periods, or data breach notification.`);
        } catch (e) {
            console.error('Embedding error:', e);
            addMessage('bot', `‚úÖ Document loaded. Ask me anything about it!`);
        }
    } else {
        addMessage('bot', `‚úÖ Loaded **${name}** with ${chunks.length} sections. AI is still loading - basic search is available.`);
    }
    
    logAudit('upload', `Loaded sample document: ${name}`);
}

// Trigger tour after unlock (override again to add tour)
const originalUnlockForTour = unlockVault;
unlockVault = async function() {
    const result = await originalUnlockForTour();
    initTour();
    return result;
};

console.log('üöÄ RegSecure AI Pro - Secure Contract Intelligence');
console.log('Version: 1.0.2 Beta | Patent Pending US 19/428,113');
console.log('Features: PDF Export, Risk Analysis, Local AI, OCR, Compare, Sample Documents');
console.log('Shortcuts: Ctrl+K (search), Ctrl+N (new), Ctrl+L (lock), Ctrl+B (backup), Ctrl+E (export)');

// ==========================================
// MOBILE DETECTION
// ==========================================
function checkMobile() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
        || window.innerWidth < 768;
    
    if (isMobile && !localStorage.getItem('mobileWarningDismissed')) {
        document.getElementById('mobileWarning').classList.remove('hidden');
    }
}

function dismissMobileWarning() {
    document.getElementById('mobileWarning').classList.add('hidden');
    localStorage.setItem('mobileWarningDismissed', 'true');
}

// ==========================================
// ERROR MODAL
// ==========================================
function showError(title, message, details = null) {
    document.getElementById('errorTitle').textContent = title;
    document.getElementById('errorMessage').textContent = message;
    
    const detailsEl = document.getElementById('errorDetails');
    if (details) {
        detailsEl.textContent = details;
        detailsEl.classList.remove('hidden');
    } else {
        detailsEl.classList.add('hidden');
    }
    
    document.getElementById('errorModal').classList.remove('hidden');
    logAudit('error', `${title}: ${message}`);
}

function hideError() {
    document.getElementById('errorModal').classList.add('hidden');
}

// GPU/WebGPU check
function checkGPUSupport() {
    if (!navigator.gpu) {
        showError(
            'WebGPU Not Supported',
            'Your browser does not support WebGPU, which is required for local AI processing. Please use the latest version of Chrome or Edge.',
            'navigator.gpu is undefined'
        );
        return false;
    }
    return true;
}

// Check on load
setTimeout(checkMobile, 500);
</script>

</body>
</html>
